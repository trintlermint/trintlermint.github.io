var he=Object.defineProperty;var ae=(C,R,S)=>R in C?he(C,R,{enumerable:!0,configurable:!0,writable:!0,value:S}):C[R]=S;var c=(C,R,S)=>ae(C,typeof R!="symbol"?R+"":R,S);var s,e;s=this,e=function(C){class R extends Error{constructor(t,i={}){super(R.i(t,i)),this.name="TextmodeError"}static i(t,i){return`${t}${i&&Object.keys(i).length>0?`

ðŸ“‹ Context:`+Object.entries(i).map(([r,n])=>`
  - ${r}: ${R.o(n)}`).join(""):""}

${"â†“".repeat(24)}
`}static o(t){if(t===null)return"null";if(t===void 0)return"undefined";if(typeof t=="string")return`"${t}"`;if(typeof t=="number"||typeof t=="boolean")return t+"";if(Array.isArray(t))return t.length===0?"[]":t.length<=5?`[${t.map(i=>R.o(i)).join(", ")}]`:`[${t.slice(0,3).map(i=>R.o(i)).join(", ")}, ... +${t.length-3} more]`;if(typeof t=="object"){const i=Object.keys(t);return i.length===0?"{}":i.length<=3?`{ ${i.map(r=>`${r}: ${R.o(t[r])}`).join(", ")} }`:`{ ${i.slice(0,2).map(r=>`${r}: ${R.o(t[r])}`).join(", ")}, ... +${i.length-2} more }`}return t+""}}var S=(l=>(l[l.SILENT=0]="SILENT",l[l.WARNING=1]="WARNING",l[l.ERROR=2]="ERROR",l[l.THROW=3]="THROW",l))(S||{});const I=class I{constructor(){c(this,"u",{globalLevel:3})}static _(){return I.l||(I.l=new I),I.l}m(t,i){const r="%c[textmode.js] Oops! (â•¯Â°â–¡Â°)â•¯ï¸µ Something went wrong in your code.",n="color: #f44336; font-weight: bold; background: #ffebee; padding: 2px 6px; border-radius: 3px;";switch(this.u.globalLevel){case 0:return!1;case 1:return console.group(r,n),console.warn(R.i(t,i)),console.groupEnd(),!1;case 2:return console.group(r,n),console.error(R.i(t,i)),console.groupEnd(),!1;default:throw new R(t,i)}}v(t,i,r){return!!t||(this.m(i,r),!1)}A(t){this.u.globalLevel=t}};c(I,"l",null);let J=I;const X=J._(),it=new WeakMap;function k(l,t){it.set(l,t)}function V(l){return it.get(l)}class st{constructor(){c(this,"C",1);c(this,"M",0);c(this,"U",0);c(this,"F",0);c(this,"R",[0,0,0]);c(this,"P",[1,1,1,1]);c(this,"S",[0,0,0,1]);c(this,"$",!1);c(this,"D",!1);c(this,"k",!1);c(this,"L",[0,0]);c(this,"O",[0,0,0,1]);c(this,"H",[])}G(){this.H.push({I:this.C,N:this.M,X:this.U,W:this.F,L:[...this.L],K:this.$,j:this.D,k:this.k,Y:[...this.R],V:[...this.P],q:[...this.S]})}Z(){const t=this.H.pop();t?(this.C=t.I,this.M=t.N,this.U=t.X,this.F=t.W,this.L=t.L,this.$=t.K,this.D=t.j,this.k=t.k,this.R=t.Y,this.P=t.V,this.S=t.q):console.warn("pop() called without matching push()")}J(t){t.I=this.C,t.N=this.M,t.X=this.U,t.W=this.F,t.Y[0]=this.R[0],t.Y[1]=this.R[1],t.Y[2]=this.R[2],t.V[0]=this.P[0],t.V[1]=this.P[1],t.V[2]=this.P[2],t.V[3]=this.P[3],t.q[0]=this.S[0],t.q[1]=this.S[1],t.q[2]=this.S[2],t.q[3]=this.S[3],t.K=this.$,t.j=this.D,t.k=this.k,t.L[0]=this.L[0],t.L[1]=this.L[1]}get lineWeight(){return this.C}get canvasBackgroundColor(){return this.O}tt(t){this.C=Math.abs(t)}st(t){this.M=t}et(t){this.U=t}it(t){this.F=t}rt(t){this.R=t}nt(t,i,r,n=255){this.P=[t/255,i/255,r/255,n/255]}ot(t,i,r,n=255){this.S=[t/255,i/255,r/255,n/255]}ht(t){this.$=t}ct(t){this.D=t}lt(t){this.k=t}ut(t){const i=255*t/360,r=Math.floor(i)/255,n=Math.round(i-Math.floor(i));this.L=[r,n]}ft(t,i,r,n){this.O=[t/255,i/255,r/255,n/255]}}class q{constructor(t,i,r=i,n=1,o={},h=null,a=!1){c(this,"dt");c(this,"_t");c(this,"u");c(this,"vt",null);c(this,"gt");c(this,"At");c(this,"yt",[]);c(this,"wt");c(this,"Ct",null);c(this,"bt",[]);c(this,"xt",null);c(this,"Mt",!1);c(this,"Ft",null);this.dt=i,this._t=r,this.u={filter:"nearest",wrap:"clamp",format:"rgba",type:"unsigned_byte",...o},this.gt=t,this.wt=Math.min(Math.max(1,n),8),this.xt=h,this.Mt=!!a,this.Ft=this.Mt?new st:null;const u=t.getParameter(t.MAX_DRAW_BUFFERS),f=t.getParameter(t.MAX_COLOR_ATTACHMENTS);this.wt=Math.min(this.wt,u,f),this.At=t.createFramebuffer(),this.zt(),this.Rt(),this.bt=Array(this.wt).fill(null)}zt(){const t=this.gt,i=this.u.filter==="linear"?t.LINEAR:t.NEAREST,r=this.u.wrap==="repeat"?t.REPEAT:t.CLAMP_TO_EDGE,n=this.u.type==="float"?t.FLOAT:t.UNSIGNED_BYTE;for(let o=0;o<this.wt;o++){const h=t.createTexture();t.bindTexture(t.TEXTURE_2D,h),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,r),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,r),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.dt,this._t,0,t.RGBA,n,null),this.yt.push(h)}t.bindTexture(t.TEXTURE_2D,null)}Rt(){const t=this.gt;if(t.bindFramebuffer(t.FRAMEBUFFER,this.At),this.wt===1)t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.yt[0],0);else{const r=[];for(let n=0;n<this.wt;n++){const o=t.COLOR_ATTACHMENT0+n;t.framebufferTexture2D(t.FRAMEBUFFER,o,t.TEXTURE_2D,this.yt[n],0),r.push(o)}t.drawBuffers(r)}const i=t.checkFramebufferStatus(t.FRAMEBUFFER);i!==t.FRAMEBUFFER_COMPLETE&&console.error("GLFramebuffer is not complete:",i),t.bindFramebuffer(t.FRAMEBUFFER,null)}Tt(t){const i=this.gt;i.bindTexture(i.TEXTURE_2D,this.yt[0]),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,1),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,t),i.bindTexture(i.TEXTURE_2D,null)}resize(t,i){this.dt=t,this._t=i,this.vt=null,this.bt=Array(this.wt).fill(null);const r=this.gt,n=this.u.type==="float"?r.FLOAT:r.UNSIGNED_BYTE;for(const o of this.yt)r.bindTexture(r.TEXTURE_2D,o),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,this.dt,this._t,0,r.RGBA,n,null);r.bindTexture(r.TEXTURE_2D,null)}readPixels(t){const i=this.gt,r=this.bt[t];if(r)return r;const n=this.dt,o=this._t,h=new Uint8Array(n*o*4),a=i.getParameter(i.READ_FRAMEBUFFER_BINDING);i.bindFramebuffer(i.READ_FRAMEBUFFER,this.At),i.readBuffer(i.COLOR_ATTACHMENT0+t),i.readPixels(0,0,n,o,i.RGBA,i.UNSIGNED_BYTE,h),i.bindFramebuffer(i.READ_FRAMEBUFFER,a);const u=4*n,f=new Uint8Array(h.length);for(let g=0;g<o;g++){const d=(o-1-g)*u,p=g*u;f.set(h.subarray(d,d+u),p)}return this.bt[t]=f,f}begin(){var i,r,n,o;const t=this.gt;if(this.xt){const h=((r=(i=this.xt).Pt)==null?void 0:r.call(i))??null;h&&this.xt.St(h),this.Mt&&this.Ft&&((o=(n=this.xt).$t)==null||o.call(n,this.Ft))}this.Ct={framebuffer:t.getParameter(t.FRAMEBUFFER_BINDING),viewport:t.getParameter(t.VIEWPORT)},t.bindFramebuffer(t.FRAMEBUFFER,this.At),this.bt=Array(this.wt).fill(null);for(let h=0;h<this.wt;h++)t.clearBufferfv(t.COLOR,h,new Float32Array([0,0,0,0]));t.viewport(0,0,this.dt,this._t),k(t,[0,0,this.dt,this._t])}end(){var i,r,n,o;if(!this.Ct)return;const t=this.gt;if(this.xt){const h=((r=(i=this.xt).Pt)==null?void 0:r.call(i))??null;h&&this.xt.St(h)}t.bindFramebuffer(t.FRAMEBUFFER,this.Ct.framebuffer),t.viewport(...this.Ct.viewport),k(t,this.Ct.viewport),this.Ct=null,this.xt&&this.Mt&&this.Ft&&((o=(n=this.xt).Et)==null||o.call(n))}Dt(){const t=this.gt;t.deleteFramebuffer(this.At);for(const i of this.yt)t.deleteTexture(i)}get width(){return this.dt}get height(){return this._t}get textures(){return[...this.yt]}}class z{constructor(t,i,r){c(this,"gt");c(this,"kt");c(this,"Bt",new Map);c(this,"Lt",new Map);c(this,"Ot",0);this.gt=t,this.kt=this.Ht(i,r),this.Gt()}Gt(){const t=this.gt.getProgramParameter(this.kt,this.gt.ACTIVE_UNIFORMS);for(let i=0;i<t;i++){const r=this.gt.getActiveUniform(this.kt,i);if(r){const n=this.gt.getUniformLocation(this.kt,r.name);if(n&&(this.Bt.set(r.name,n),this.Lt.set(r.name,{type:r.type,size:r.size}),r.size>1)){const o=r.name.replace(/\[.*\]$/,"");this.Bt.has(o)||(this.Bt.set(o,n),this.Lt.set(o,{type:r.type,size:r.size}))}}}}Ht(t,i){const r=this.It(this.gt.VERTEX_SHADER,t),n=this.It(this.gt.FRAGMENT_SHADER,i),o=this.gt.createProgram();if(this.gt.attachShader(o,r),this.gt.attachShader(o,n),this.gt.linkProgram(o),!this.gt.getProgramParameter(o,this.gt.LINK_STATUS)){const h=this.gt.getProgramInfoLog(o);throw Error("Shader program link error: "+h)}return this.gt.deleteShader(r),this.gt.deleteShader(n),o}It(t,i){const r=this.gt.createShader(t);if(this.gt.shaderSource(r,i),this.gt.compileShader(r),!this.gt.getShaderParameter(r,this.gt.COMPILE_STATUS)){const n=this.gt.getShaderInfoLog(r);throw this.gt.deleteShader(r),Error("Shader compilation error: "+n)}return r}Nt(){this.gt.useProgram(this.kt),this.Xt()}Xt(){this.Ot=0}Wt(t){for(const[i,r]of Object.entries(t))this.Kt(i,r)}jt(t){return this.Bt.has(t)}Yt(t){return this.Lt.get(t)||null}Vt(){const t=[];for(const[i,r]of this.Lt.entries())t.push({name:i,...r});return t}Kt(t,i){var u;const r=this.Bt.get(t);if(!r)return;const n=this.Lt.get(t);if(!n)return void console.warn(`No type information found for uniform '${t}'`);const{type:o,size:h}=n,a=this.gt;if(typeof i=="number")switch(o){case a.INT:case a.BOOL:a.uniform1i(r,i);break;case a.FLOAT:a.uniform1f(r,i);break;default:console.warn(`Unexpected uniform type for scalar '${t}': ${o}`),a.uniform1f(r,i)}else if(typeof i=="boolean")a.uniform1i(r,i?1:0);else if(Array.isArray(i))if(Array.isArray(i[0])){const f=i,g=((u=f[0])==null?void 0:u.length)||0,d=f.flat();switch(o){case a.FLOAT_VEC2:g===2?a.uniform2fv(r,d):console.warn(`Vector length mismatch for '${t}': expected 2, got ${g}`);break;case a.FLOAT_VEC3:g===3?a.uniform3fv(r,d):console.warn(`Vector length mismatch for '${t}': expected 3, got ${g}`);break;case a.FLOAT_VEC4:g===4?a.uniform4fv(r,d):console.warn(`Vector length mismatch for '${t}': expected 4, got ${g}`);break;default:console.warn(`Unsupported uniform type for vector array '${t}': ${o}`)}}else switch(o){case a.FLOAT_VEC2:i.length===2?a.uniform2f(r,i[0],i[1]):console.warn(`Vector length mismatch for '${t}': expected 2, got ${i.length}`);break;case a.FLOAT_VEC3:i.length===3?a.uniform3f(r,i[0],i[1],i[2]):console.warn(`Vector length mismatch for '${t}': expected 3, got ${i.length}`);break;case a.FLOAT_VEC4:i.length===4?a.uniform4f(r,i[0],i[1],i[2],i[3]):console.warn(`Vector length mismatch for '${t}': expected 4, got ${i.length}`);break;case a.INT:h>1?a.uniform1iv(r,i):console.warn(`Array provided for scalar uniform '${t}'`);break;case a.FLOAT:h>1?a.uniform1fv(r,i):console.warn(`Array provided for scalar uniform '${t}'`);break;default:console.warn(`Unsupported uniform type for array '${t}': ${o}`)}else if(i instanceof WebGLTexture){const f=this.qt();a.uniform1i(r,f),a.activeTexture(a.TEXTURE0+f),a.bindTexture(a.TEXTURE_2D,i)}else if(i instanceof q){const f=this.qt();a.uniform1i(r,f),a.activeTexture(a.TEXTURE0+f),a.bindTexture(a.TEXTURE_2D,i.textures[0])}else console.warn(`Unsupported uniform type for '${t}':`,typeof i)}qt(){return this.Ot++}get Zt(){return this.kt}Dt(){this.gt.deleteProgram(this.kt)}}const K=`#version 300 es
in vec2 a_position;in vec2 a_texCoord;in vec2 a_instancePosition;in vec2 a_instanceSize;in vec3 a_instanceCharacter;in vec4 a_instancePrimaryColor;in vec4 a_instanceSecondaryColor;in vec2 a_instanceRotation;in vec3 a_instanceTransform;in vec3 a_instanceGlobalRotation;in vec2 a_instanceRotationCenter;in vec2 a_instanceBezierCP1;in vec2 a_instanceBezierCP2;in vec2 a_instanceBezierStart;in vec2 a_instanceBezierEnd;in vec2 a_instanceArcAngles;uniform float U9;uniform vec2 Uw;out vec2 v_uv;out vec3 v_character;out vec4 v_primaryColor;out vec4 v_secondaryColor;out vec2 v_rotation;out vec3 v_transform;mat3 A(float B){float C=sin(B),D=cos(B);return mat3(1,0,0,0,D,-C,0,C,D);}mat3 E(float B){float C=sin(B),D=cos(B);return mat3(D,0,C,0,1,0,-C,0,D);}mat3 F(float B){float C=sin(B),D=cos(B);return mat3(D,-C,0,C,D,0,0,0,1);}vec2 G(float H,vec2 I,vec2 J,vec2 K,vec2 L){float M=1.-H,N=M*M,O=H*H;return N*M*I+3.*N*H*J+3.*M*O*K+O*H*L;}vec2 P(float H,vec2 I,vec2 J,vec2 K,vec2 L){float M=1.-H,N=M*M,O=H*H;return-3.*N*I+3.*N*J-6.*M*H*J+6.*M*H*K-3.*O*K+3.*O*L;}void main(){v_uv=a_texCoord;v_character=a_instanceCharacter;v_primaryColor=a_instancePrimaryColor;v_secondaryColor=a_instanceSecondaryColor;v_rotation=a_instanceRotation;v_transform=a_instanceTransform;vec2 Q;bool R=length(a_instanceBezierCP1)+length(a_instanceBezierCP2)+length(a_instanceBezierStart)+length(a_instanceBezierEnd)>0.;bool S=a_instanceArcAngles.x!=0.||a_instanceArcAngles.y!=0.;if(R){float H=a_position.x;vec2 T=G(H,a_instanceBezierStart,a_instanceBezierCP1,a_instanceBezierCP2,a_instanceBezierEnd);vec2 U=P(H,a_instanceBezierStart,a_instanceBezierCP1,a_instanceBezierCP2,a_instanceBezierEnd);float V=length(U);U=V>0.?U/V:vec2(1,0);Q=T+vec2(-U.y,U.x)*a_position.y*a_instanceSize.y;}else if(S){float C=a_instanceArcAngles.x,W=a_instanceArcAngles.y;C=mod(C,6.28318530718);if(C<0.)C+=6.28318530718;W=mod(W,6.28318530718);if(W<0.)W+=6.28318530718;float X=C-W;if(X<=0.)X+=6.28318530718;float Y=C-a_position.x*X;vec2 Z=vec2(cos(Y),sin(Y))*a_position.y;Q=Z*a_instanceSize*.5+a_instanceSize*.5+a_instancePosition;}else{Q=a_position*a_instanceSize+a_instancePosition;}vec2 a=(Q/Uw)*2.-1.;a.y=-a.y;if(length(a_instanceGlobalRotation)>0.){vec3 b=vec3(a-a_instanceRotationCenter,0);b.x*=U9;if(a_instanceGlobalRotation.x!=0.)b=A(-a_instanceGlobalRotation.x)*b;if(a_instanceGlobalRotation.y!=0.)b=E(-a_instanceGlobalRotation.y)*b;if(a_instanceGlobalRotation.z!=0.)b=F(-a_instanceGlobalRotation.z)*b;b.x/=U9;a=b.xy+a_instanceRotationCenter;}gl_Position=vec4(a,0,1);}`,rt="attribute vec2 a_position;attribute vec2 a_texCoord;varying vec2 v_uv;void main(){v_uv=a_texCoord;gl_Position=vec4(a_position,0.,1.);}";class mt{constructor(t){c(this,"gt");c(this,"Qt");c(this,"Jt");c(this,"ts");c(this,"ss");this.gt=t,this.Jt=new z(this.gt,K,`#version 300 es
precision highp float;in vec2 v_uv;in vec3 v_character;in vec4 v_primaryColor;in vec4 v_secondaryColor;in vec2 v_rotation;in vec3 v_transform;layout(location=0)out vec4 o_character;layout(location=1)out vec4 o_primaryColor;layout(location=2)out vec4 o_secondaryColor;layout(location=3)out vec4 o_rotation;layout(location=4)out vec4 o_transform;void main(){o_character=vec4(v_character,1.);o_primaryColor=v_primaryColor;o_secondaryColor=v_secondaryColor;o_rotation=vec4(v_rotation,0.,1.);o_transform=vec4(v_transform,1.);}`),this.Qt=new z(this.gt,K,`#version 300 es
precision highp float;in vec2 v_uv;uniform sampler2D Ue;uniform sampler2D Uf;uniform sampler2D Ug;uniform sampler2D Uh;uniform sampler2D Ui;uniform vec2 Uj;layout(location=0)out vec4 o_character;layout(location=1)out vec4 o_primaryColor;layout(location=2)out vec4 o_secondaryColor;layout(location=3)out vec4 o_rotation;layout(location=4)out vec4 o_transform;void main(){vec2 A=vec2(v_uv.x,1.-v_uv.y);vec2 B=A*Uj;vec2 C=(floor(B)+0.5f)/Uj;vec4 D=texture(Ue,C);vec4 E=texture(Uf,C);if(E.a==0.){discard;}vec4 F=texture(Ug,C);vec4 G=texture(Uh,C);vec4 H=texture(Ui,C);o_character=D;o_primaryColor=E;o_secondaryColor=F;o_rotation=G;o_transform=H;}`),this.ts=new z(this.gt,rt,"precision mediump float;uniform sampler2D U0;uniform vec2 U1;uniform sampler2D U3;uniform sampler2D U4;uniform sampler2D U5;uniform sampler2D U2;uniform sampler2D U6;uniform vec2 U7;uniform vec2 U8;mat2 A(float B){float C=sin(B);float D=cos(B);return mat2(D,-C,C,D);}void main(){vec2 E=gl_FragCoord.xy/U8;vec2 F=E*U7;vec2 G=floor(F);vec2 H=(G+0.5)/U7;vec4 I=texture2D(U3,H);vec4 J=texture2D(U4,H);vec4 K=texture2D(U5,H);bool L=K.r>0.5;bool M=K.g>0.5;bool N=K.b>0.5;vec4 O=texture2D(U2,H);int P=int(O.r*255.+0.5)+int(O.g*255.+0.5)*256;int Q=int(mod(float(P),U1.x));int R=P/int(U1.x);float S=(U1.y-1.)-float(R);vec2 T=vec2(float(Q),S)/U1;vec4 U=texture2D(U6,H);float V=U.r*255.+U.g;float W=-(V*360./255.)*0.017453292;vec2 X=fract(F)-0.5;if(M)X.x=-X.x;if(N)X.y=-X.y;X=A(W)*X+0.5;vec2 Y=1./U1;vec2 Z=T+X*Y;vec2 a=T+Y;if(any(lessThan(Z,T))||any(greaterThan(Z,a))){gl_FragColor=L?I:J;return;}vec4 b=texture2D(U0,Z);if(L)b.rgb=1.-b.rgb;gl_FragColor=mix(J,I,b);}"),this.ss=new z(this.gt,K,`#version 300 es
precision highp float;in vec2 v_uv;uniform sampler2D Uk;uniform bool Ul;uniform bool Um;uniform bool Un;uniform vec2 Uo;uniform bool Up;uniform vec4 Uq;uniform bool Ur;uniform vec4 Us;uniform vec4 Ut;uniform int Uu;uniform vec3 Uv[64];layout(location=0)out vec4 o_character;layout(location=1)out vec4 o_primaryColor;layout(location=2)out vec4 o_secondaryColor;layout(location=3)out vec4 o_rotation;layout(location=4)out vec4 o_transform;float A(vec3 B){return dot(B,vec3(0.299f,0.587f,0.114f));}void main(){vec2 C=vec2(v_uv.x,1.0f-v_uv.y);vec4 D=texture(Uk,C);float E=A(D.rgb);if(Uu>0){float F=float(Uu);float G=clamp(E*(F-1.0f),0.0f,F-1.0f);int H=int(floor(G+0.5f));vec3 I=Uv[H];o_character=vec4(I,1.0f);}else{o_character=vec4(E,0.0f,0.0f,1.0f);}vec4 J=Up?Uq:D;vec4 K=Ur?Us:D;if(D.a<0.01f){J=Ut;K=Ut;}else{}o_primaryColor=vec4(J);o_secondaryColor=vec4(K);o_rotation=vec4(Uo.xy,0.0f,1.0f);o_transform=vec4(float(Ul),float(Um),float(Un),1.0f);}`)}es(){return this.Qt}Pt(){return this.Jt}rs(){return this.ts}ns(){return this.ss}hs(t){return new z(this.gt,K,t)}cs(t,i){return new z(this.gt,t,i)}Dt(){this.Qt.Dt(),this.Jt.Dt(),this.ts.Dt(),this.ss.Dt()}}var E=(l=>(l.RECTANGLE="rectangle",l.LINE="line",l.ELLIPSE="ellipse",l.ARC="arc",l.TRIANGLE="triangle",l.BEZIER_CURVE="bezier_curve",l.CUSTOM="custom",l))(E||{});class At{constructor(t){c(this,"gt");c(this,"ls",new Map);this.gt=t}us(t,i,r,n){const o=this.gt;let h=this.ls.get(t);h||(h=new Map,this.ls.set(t,h));let a=h.get(i)||null;if(!a){a=o.createVertexArray(),h.set(i,a),o.bindVertexArray(a),o.bindBuffer(o.ARRAY_BUFFER,n);const u=o.getAttribLocation(t,"a_position");u!==-1&&(o.enableVertexAttribArray(u),o.vertexAttribPointer(u,r.ds.fs.size,o.FLOAT,!1,r.ps,r.ds.fs.offset),o.vertexAttribDivisor(u,0));const f=o.getAttribLocation(t,"a_texCoord");f!==-1&&(o.enableVertexAttribArray(f),o.vertexAttribPointer(f,r.ds._s.size,o.FLOAT,!1,r.ps,r.ds._s.offset),o.vertexAttribDivisor(f,0))}o.bindVertexArray(a)}vs(){this.gt.bindVertexArray(null)}Dt(){for(const[,t]of this.ls)for(const[,i]of t)i&&this.gt.deleteVertexArray(i)}}class pt{constructor(t,i){c(this,"gs");c(this,"gt");c(this,"xt");c(this,"As",null);c(this,"ws",null);this.gt=t,this.gs=new At(t),this.xt=i}Cs(t,i,r){const{shader:n}=t,o=V(this.gt)||this.gt.getParameter(this.gt.VIEWPORT);n.Wt({U9:o[2]/o[3],Uw:[o[2],o[3]]});const h=f=>{if(!f||!f.bs())return;const g=f.unitGeometry,d=f.unitBuffer;try{this.gs.us(n.Zt,f.type+"",g,d),f.batch.Ms(n),f.batch.Fs(g.zs,g.Rs)}finally{f.batch.Ts(n),this.gs.vs(),f.Ps()}};let a=null,u=null;for(const f of i){if(f.type===E.CUSTOM){u&&(h(u),a=null,u=null),this.Ss(t,f.params,f.state,r.get(E.RECTANGLE));continue}a!==null&&f.type!==a&&(h(u),a=null,u=null);let g=u;g&&f.type===a||(g=r.get(f.type)||null,u=g,a=f.type),g&&g.$s(f.params,f.state)}h(u)}Ss(t,i,r,n){const{x:o,y:h,width:a,height:u,shader:f,uniforms:g}=i,d=this.Es(Math.max(1,Math.floor(a)),Math.max(1,Math.floor(u)));d.begin(),this.Ds(n,f,g,0,0,d.width,d.height,{}),d.end();const p=this.ks(),y={Ue:d.textures[0],Uf:d.textures[1],Ug:d.textures[2],Uh:d.textures[3],Ui:d.textures[4],Uj:[d.width,d.height]};this.Ds(n,p,y,Math.floor(o),Math.floor(h),Math.max(1,Math.floor(a)),Math.max(1,Math.floor(u)),r),t.shader.Nt()}Ds(t,i,r,n,o,h,a,u){i.Nt(),i.Wt(r);const f=this.gt.getParameter(this.gt.VIEWPORT);if(i.Wt({U9:f[2]/f[3],Uw:[f[2],f[3]]}),t.Ps(),t.$s({x:n,y:o,width:h,height:a},u),t.bs()){const g=t.unitGeometry,d=t.unitBuffer;try{this.gs.us(i.Zt,t.type+"",g,d),t.batch.Ms(i),t.batch.Fs(g.zs,g.Rs)}finally{t.batch.Ts(i),this.gs.vs(),t.Ps()}}}ks(){return this.xt.es()}Es(t,i){return this.As&&this.ws&&this.ws.w===t&&this.ws.h===i||(this.As&&this.As.Dt(),this.As=new q(this.gt,t,i,5),this.ws={w:t,h:i}),this.As}Dt(){this.gs.Dt(),this.As&&this.As.Dt()}}class vt{constructor(){c(this,"Bs",[]);c(this,"Ls",1);c(this,"Os",0)}Hs(t){if(this.Os>=this.Bs.length){const r={id:this.Ls++,type:t,params:{},state:{I:1,N:0,X:0,W:0,Y:[0,0,0],V:[1,1,1,1],q:[0,0,0,1],K:!1,j:!1,k:!1,L:[0,0]}};this.Bs.push(r)}const i=this.Bs[this.Os];return i.id=this.Ls++,i.type=t,this.Os++,i}Gs(t,i,r,n,o){const h=this.Hs(E.RECTANGLE);return h.params.x=t,h.params.y=i,h.params.width=r,h.params.height=n,o.J(h.state),h.id}Is(t,i,r,n,o,h,a){const u=this.Hs(E.CUSTOM);return u.params.x=t,u.params.y=i,u.params.width=r,u.params.height=n,u.params.shader=o,u.params.uniforms=h,a.J(u.state),u.id}Ns(t,i,r,n,o,h){const a=this.Hs(E.LINE);return a.params.x1=t,a.params.y1=i,a.params.x2=r,a.params.y2=n,a.params.thickness=o,h.J(a.state),a.id}Xs(t,i,r,n,o){const h=this.Hs(E.ELLIPSE);return h.params.x=t,h.params.y=i,h.params.width=r,h.params.height=n,o.J(h.state),h.id}Ws(t,i,r,n,o,h,a){const u=this.Hs(E.ARC);return u.params.x=t,u.params.y=i,u.params.width=r,u.params.height=n,u.params.start=o,u.params.stop=h,a.J(u.state),u.id}Ks(t,i,r,n,o,h,a){const u=this.Hs(E.TRIANGLE);return u.params.x1=t,u.params.y1=i,u.params.x2=r,u.params.y2=n,u.params.x3=o,u.params.y3=h,a.J(u.state),u.id}js(t,i,r,n,o,h,a,u,f,g){const d=this.Hs(E.BEZIER_CURVE);return d.params.x1=t,d.params.y1=i,d.params.cp1x=r,d.params.cp1y=n,d.params.cp2x=o,d.params.cp2y=h,d.params.x2=a,d.params.y2=u,d.params.thickness=f,g.J(d.state),d.id}get length(){return this.Os}get isEmpty(){return this.Os===0}Ys(){this.Os=0}[Symbol.iterator](){let t=0;const i=this.Os,r=this.Bs;return{next:()=>t<i?{value:r[t++],done:!1}:{value:void 0,done:!0}}}}const _=class _{static Vs(t,i,r=0){var h,a,u,f,g,d,p,y,A,m;const n=i||new Float32Array(_.FLOATS_PER_INSTANCE);let o=r;return n[o++]=t.fs[0],n[o++]=t.fs[1],n[o++]=t.Os[0],n[o++]=t.Os[1],n[o++]=t.Y[0],n[o++]=t.Y[1],n[o++]=t.Y[2],n[o++]=t.V[0],n[o++]=t.V[1],n[o++]=t.V[2],n[o++]=t.V[3],n[o++]=t.q[0],n[o++]=t.q[1],n[o++]=t.q[2],n[o++]=t.q[3],n[o++]=t.L[0],n[o++]=t.L[1],n[o++]=t.qs[0],n[o++]=t.qs[1],n[o++]=t.qs[2],n[o++]=t.N,n[o++]=t.X,n[o++]=t.W,n[o++]=t.Zs[0],n[o++]=t.Zs[1],n[o++]=((h=t.Qs)==null?void 0:h[0])||0,n[o++]=((a=t.Qs)==null?void 0:a[1])||0,n[o++]=((u=t.Js)==null?void 0:u[0])||0,n[o++]=((f=t.Js)==null?void 0:f[1])||0,n[o++]=((g=t.te)==null?void 0:g[0])||0,n[o++]=((d=t.te)==null?void 0:d[1])||0,n[o++]=((p=t.se)==null?void 0:p[0])||0,n[o++]=((y=t.se)==null?void 0:y[1])||0,n[o++]=((A=t.ee)==null?void 0:A[0])||0,n[o++]=((m=t.ee)==null?void 0:m[1])||0,n}static ie(t){const i=t.length*_.FLOATS_PER_INSTANCE,r=new Float32Array(i);for(let n=0;n<t.length;n++){const o=n*_.FLOATS_PER_INSTANCE;_.Vs(t[n],r,o)}return r}};c(_,"BYTES_PER_INSTANCE",140),c(_,"FLOATS_PER_INSTANCE",35);let B=_;const F=class F{};c(F,"STRIDE",B.BYTES_PER_INSTANCE),c(F,"ATTRIBUTES",{a_instancePosition:{location:-1,size:2,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:F.STRIDE,offset:0,divisor:1},a_instanceSize:{location:-1,size:2,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:F.STRIDE,offset:8,divisor:1},a_instanceCharacter:{location:-1,size:3,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:F.STRIDE,offset:16,divisor:1},a_instancePrimaryColor:{location:-1,size:4,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:F.STRIDE,offset:28,divisor:1},a_instanceSecondaryColor:{location:-1,size:4,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:F.STRIDE,offset:44,divisor:1},a_instanceRotation:{location:-1,size:2,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:F.STRIDE,offset:60,divisor:1},a_instanceTransform:{location:-1,size:3,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:F.STRIDE,offset:68,divisor:1},a_instanceGlobalRotation:{location:-1,size:3,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:F.STRIDE,offset:80,divisor:1},a_instanceRotationCenter:{location:-1,size:2,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:F.STRIDE,offset:92,divisor:1},a_instanceArcAngles:{location:-1,size:2,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:F.STRIDE,offset:100,divisor:1},a_instanceBezierCP1:{location:-1,size:2,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:F.STRIDE,offset:108,divisor:1},a_instanceBezierCP2:{location:-1,size:2,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:F.STRIDE,offset:116,divisor:1},a_instanceBezierStart:{location:-1,size:2,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:F.STRIDE,offset:124,divisor:1},a_instanceBezierEnd:{location:-1,size:2,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:F.STRIDE,offset:132,divisor:1}});let j=F;class yt{constructor(t,i=1e3,r=1.5){c(this,"gt");c(this,"re",[]);c(this,"ne");c(this,"oe");c(this,"he",null);c(this,"ae",!0);c(this,"ce",0);c(this,"le",new Map);c(this,"ue",null);this.gt=t,this.ne=i,this.oe=r,this.fe()}$s(t){const i=this.re.length;return this.re.push(t),this.ae=!0,i}get count(){return this.re.length}get isEmpty(){return this.re.length===0}clear(){this.re.length=0,this.ae=!0}de(t){if(t<=this.ne)return;const i=Math.ceil(t*this.oe);this.ne=i,this.fe()}fe(){const t=this.gt;this.he&&t.deleteBuffer(this.he),this.he=t.createBuffer();const i=this.ne*B.BYTES_PER_INSTANCE;t.bindBuffer(t.ARRAY_BUFFER,this.he),t.bufferData(t.ARRAY_BUFFER,i,t.DYNAMIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),this.ae=!0,this.ce=0}pe(){if(!this.ae||this.re.length===0)return;const t=this.gt,i=this.re.length;this.de(i),(!this.ue||this.ue.length<i*B.FLOATS_PER_INSTANCE)&&(this.ue=new Float32Array(i*B.FLOATS_PER_INSTANCE));const r=B.ie(this.re);t.bindBuffer(t.ARRAY_BUFFER,this.he),i<=this.ce?t.bufferSubData(t.ARRAY_BUFFER,0,r):t.bufferData(t.ARRAY_BUFFER,r,t.DYNAMIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),this.ae=!1,this.ce=i}_e(t){let i=this.le.get(t);if(!i){i=new Map;const r=this.gt;for(const n in j.ATTRIBUTES){const o=r.getAttribLocation(t,n);o!==-1&&i.set(n,o)}this.le.set(t,i)}return i}Ms(t){if(!this.he||this.re.length===0)return;const i=this.gt,r=t.Zt;this.pe();const n=this._e(r);i.bindBuffer(i.ARRAY_BUFFER,this.he);for(const[o,h]of n){const a=j.ATTRIBUTES[o];a&&(i.enableVertexAttribArray(h),i.vertexAttribPointer(h,a.size,a.type,a.normalized,a.stride,a.offset),i.vertexAttribDivisor(h,a.divisor))}}Ts(t){const i=this.gt,r=this._e(t.Zt);for(const[,n]of r)i.disableVertexAttribArray(n),i.vertexAttribDivisor(n,0)}Fs(t,i){this.re.length!==0&&this.gt.drawArraysInstanced(t,0,i,this.re.length)}Dt(){this.he&&this.gt.deleteBuffer(this.he)}}class G{constructor(t,i,r,n){c(this,"gt");c(this,"me");c(this,"ve");c(this,"ge");c(this,"Ae",null);this.gt=t,this.me=i,this.ve=r,this.ge=n;const o=this.gt.createBuffer();if(!o)throw Error("Failed to create unit geometry buffer");this.gt.bindBuffer(this.gt.ARRAY_BUFFER,o),this.gt.bufferData(this.gt.ARRAY_BUFFER,this.ge.ye,this.gt.STATIC_DRAW),this.gt.bindBuffer(this.gt.ARRAY_BUFFER,null),this.Ae=o}get type(){return this.ve}get unitGeometry(){return this.ge}get unitBuffer(){return this.Ae}get batch(){return this.me}Ps(){this.me.clear()}bs(){return!this.me.isEmpty}Dt(){this.me.Dt(),this.gt.deleteBuffer(this.Ae)}we(t,i,r,n,o){const h=this.Ce(t,i,r,n,o.N||0,o.X||0,o.W||0);return{fs:[t,i],Os:[r,n],Y:o.Y||[0,0,0],V:o.V||[1,1,1,1],q:o.q||[0,0,0,1],L:o.L||[0,0],qs:[o.k?1:0,o.K?1:0,o.j?1:0],N:h.radiansX,X:h.radiansY,W:h.radiansZ,Zs:[h.centerX,h.centerY]}}be(t,i){const r=V(this.gt)||[0,0,this.gt.canvas.width,this.gt.canvas.height];return{nx:t/r[2]*2-1,ny:1-i/r[3]*2}}xe(t,i,r){const n=this.be(i,r);t.Zs=[n.nx,n.ny]}Ce(t,i,r,n,o,h,a){const u=V(this.gt)||[0,0,this.gt.canvas.width,this.gt.canvas.height],f=u[2],g=u[3];return{centerX:(t+r/2)/f*2-1,centerY:1-(i+n/2)/g*2,radiansX:-o*Math.PI/180,radiansY:-h*Math.PI/180,radiansZ:-a*Math.PI/180,aspectRatio:f/g}}}const xt={ye:new Float32Array([0,0,0,0,1,0,1,0,0,1,0,1,0,1,0,1,1,0,1,0,1,1,1,1]),Rs:6,zs:WebGL2RenderingContext.TRIANGLES,ps:16,ds:{fs:{size:2,offset:0},_s:{size:2,offset:8}}};class wt extends G{constructor(t,i){super(t,i,E.RECTANGLE,xt)}$s(t,i){const r=this.we(t.x,t.y,t.width,t.height,i);return this.me.$s(r)}}const Et={ye:new Float32Array([0,-.5,0,0,1,-.5,1,0,0,.5,0,1,0,.5,0,1,1,-.5,1,0,1,.5,1,1]),Rs:6,zs:WebGL2RenderingContext.TRIANGLES,ps:16,ds:{fs:{size:2,offset:0},_s:{size:2,offset:8}}};class Tt extends G{constructor(t,i){super(t,i,E.LINE,Et)}$s(t,i){const r=t.x2-t.x1,n=t.y2-t.y1,o=Math.hypot(r,n),h=t.thickness||i.I||1,a=t.x1+r/2,u=t.y1+n/2,f=a-o/2,g=u,d=this.we(f,g,o,h,i);return this.xe(d,a,u),this.me.$s(d)}}const Rt={ye:function(l=32){const t=[],i=2*Math.PI/l;for(let r=0;r<l;r++){const n=r*i,o=(r+1)%l*i,h=Math.cos(n),a=Math.sin(n),u=.5*(h+1),f=.5*(a+1),g=Math.cos(o),d=Math.sin(o),p=.5*(g+1),y=.5*(d+1);t.push(0,0,.5,.5,h,a,u,f,g,d,p,y)}return new Float32Array(t)}(32),Rs:96,zs:WebGL2RenderingContext.TRIANGLES,ps:16,ds:{fs:{size:2,offset:0},_s:{size:2,offset:8}}};class bt extends G{constructor(t,i){super(t,i,E.ELLIPSE,Rt)}$s(t,i){const r=this.we(t.x,t.y,t.width,t.height,i);return this.xe(r,t.x,t.y),this.me.$s(r)}}let Ct={ye:function(l){const t=[];for(let i=0;i<l;i++){const r=i/l,n=(i+1)/l;t.push(r,0,r,0,r,1,r,1,n,1,n,1)}return new Float32Array(t)}(32),Rs:96,zs:WebGL2RenderingContext.TRIANGLES,ps:16,ds:{fs:{size:2,offset:0},_s:{size:2,offset:8}}};class Ft extends G{constructor(t,i){super(t,i,E.ARC,Ct)}$s(t,i){const r=t.x-t.width/2,n=t.y-t.height/2,o=t.start*Math.PI/180,h=t.stop*Math.PI/180,a=this.we(r,n,t.width,t.height,i);return this.xe(a,t.x,t.y),a.Qs=[o,h],this.me.$s(a)}}const Ut={ye:new Float32Array([0,0,0,0,1,0,1,0,.5,1,.5,1]),Rs:3,zs:WebGL2RenderingContext.TRIANGLES,ps:16,ds:{fs:{size:2,offset:0},_s:{size:2,offset:8}}};class Pt extends G{constructor(t,i){super(t,i,E.TRIANGLE,Ut)}$s(t,i){const r=Math.min(t.x1,t.x2,t.x3),n=Math.max(t.x1,t.x2,t.x3),o=Math.min(t.y1,t.y2,t.y3),h=n-r,a=Math.max(t.y1,t.y2,t.y3)-o,u=this.we(r,o,h,a,i),f=r+.5*h,g=o+a*(1/3);return this.xe(u,f,g),this.me.$s(u)}}function nt(l,t,i,r,n){const o=1-l,h=o*o,a=l*l;return h*o*t+3*h*l*i+3*o*a*r+a*l*n}const Ot={ye:function(l=16){const t=[];for(let i=0;i<l;i++){const r=i/l,n=(i+1)/l;t.push(r,-.5,r,0),t.push(n,-.5,n,0),t.push(r,.5,r,1),t.push(r,.5,r,1),t.push(n,-.5,n,0),t.push(n,.5,n,1)}return new Float32Array(t)}(16),Rs:96,zs:WebGL2RenderingContext.TRIANGLES,ps:16,ds:{fs:{size:2,offset:0},_s:{size:2,offset:8}}};class Mt extends G{constructor(t,i){super(t,i,E.BEZIER_CURVE,Ot)}$s(t,i){const r=i.I||1,n=nt(.5,t.x1,t.cp1x,t.cp2x,t.x2),o=nt(.5,t.y1,t.cp1y,t.cp2y,t.y2),h=this.we(0,0,1,r,i);return this.xe(h,n,o),h.se=[t.x1,t.y1],h.Js=[t.cp1x,t.cp1y],h.te=[t.cp2x,t.cp2y],h.ee=[t.x2,t.y2],this.me.$s(h)}}class Lt{constructor(t){c(this,"gt");c(this,"Me",null);c(this,"Fe");c(this,"ze",null);c(this,"Re",{});c(this,"Te",null);c(this,"Pe",new Map);c(this,"Se");c(this,"$e");c(this,"Ee");c(this,"H",[]);this.gt=t,this.Fe=new mt(t),this.Ee=new st,this.Se=new pt(t,this),this.$e=new vt,this.Te=t.createBuffer(),k(this.gt,[0,0,this.gt.canvas.width,this.gt.canvas.height])}De(t){let i=this.Pe.get(t);if(i)return i;const r=new yt(this.gt);return i=(0,{[E.RECTANGLE]:()=>new wt(this.gt,r),[E.LINE]:()=>new Tt(this.gt,r),[E.ELLIPSE]:()=>new bt(this.gt,r),[E.ARC]:()=>new Ft(this.gt,r),[E.TRIANGLE]:()=>new Pt(this.gt,r),[E.BEZIER_CURVE]:()=>new Mt(this.gt,r)}[t])(),this.Pe.set(t,i),i}ke(t){this.Me!==t&&(this.Me=t,t.Nt())}cs(t,i){return this.Fe.cs(t,i)}es(){return this.Fe.es()}Pt(){return this.Fe.Pt()}rs(){return this.Fe.rs()}ns(){return this.Fe.ns()}Be(t){this.ze=t,t&&(this.Re={})}Kt(t,i){this.Re[t]=i}Le(t){Object.assign(this.Re,t)}hs(t){return this.Fe.hs(t)}Oe(t,i,r,n,o){const h=this.es(),a={Ue:t.textures[0],Uf:t.textures[1],Ug:t.textures[2],Uh:t.textures[3],Ui:t.textures[4],Uj:[t.width,t.height]};this.$e.Is(i,r,n,o,h,a,this.Ee)}He(t,i,r,n,o){const h=this.ns(),a=t.Ge(),u={Uk:a.texture,Ul:!!a.invert,Um:!!a.flipX,Un:!!a.flipY,Uo:a.charRotation,Up:a.charColorFixed,Uq:a.charColor,Ur:a.cellColorFixed,Us:a.cellColor,Ut:a.backgroundColor,Uu:a.charCount,Uv:a.charList};this.$e.Is(i,r,n,o,h,u,this.Ee)}Ie(t,i,r,n){var m;const o=this.gt,h=o.canvas.width,a=o.canvas.height,u=t/h*2-1,f=(t+r)/h*2-1,g=1-i/a*2,d=1-(i+n)/a*2,p=new Float32Array([u,d,f,d,u,g,f,d,f,g,u,g]);o.bindBuffer(o.ARRAY_BUFFER,this.Te),o.bufferData(o.ARRAY_BUFFER,p,o.DYNAMIC_DRAW);const y=((m=this.Me)==null?void 0:m.Zt)||o.getParameter(o.CURRENT_PROGRAM),A=y?o.getAttribLocation(y,"a_position"):-1;A!==-1&&(o.enableVertexAttribArray(A),o.vertexAttribPointer(A,2,o.FLOAT,!1,8,0)),o.drawArrays(o.TRIANGLES,0,6),A!==-1&&o.disableVertexAttribArray(A)}Ne(t,i,r,n){this.ze?(this.$e.Is(t,i,r,n,this.ze,{...this.Re},this.Ee),this.ze=null,this.Re={}):this.$e.Gs(t,i,r,n,this.Ee)}Xe(t,i,r,n){this.$e.Ns(t,i,r,n,this.Ee.lineWeight,this.Ee)}We(t,i,r,n){this.$e.Xs(t,i,r,n,this.Ee)}Ke(t,i,r,n,o,h){this.$e.Ks(t,i,r,n,o,h,this.Ee)}je(t,i,r,n,o,h,a,u){const f=this.Ee.lineWeight;this.$e.js(t,i,r,n,o,h,a,u,f,this.Ee)}Ye(t,i,r=1,n={}){return new q(this.gt,t,i,r,n,this,!0)}Ve(t,i,r,n,o,h){this.$e.Ws(t,i,r,n,o,h,this.Ee)}qe(t,i=t,r=t,n=255){this.Ee.ft(t,i,r,n),this.Ys(t/255,i/255,r/255,n/255)}Ys(t=0,i=0,r=0,n=0){this.gt.clearColor(t,i,r,n),this.gt.clear(this.gt.COLOR_BUFFER_BIT)}Ze(){this.gt.viewport(0,0,this.gt.canvas.width,this.gt.canvas.height),k(this.gt,[0,0,this.gt.canvas.width,this.gt.canvas.height])}get context(){return this.gt}get state(){return this.Ee}$t(t){this.H.push(this.Ee),this.Ee=t}Et(){const t=this.H.pop();t&&(this.Ee=t)}St(t){const i=t,r=V(this.gt)??this.gt.getParameter(this.gt.VIEWPORT),n={shader:i,gl:this.gt,viewport:r};this.ke(i);const o=new Set;for(const h of this.$e)h.type===E.CUSTOM?o.add(E.RECTANGLE):o.add(h.type);for(const h of o)h!==E.CUSTOM&&this.De(h);this.Se.Cs(n,this.$e,this.Pe),this.$e.Ys()}Dt(){this.gt.deleteBuffer(this.Te),this.$e.Ys();for(const t of this.Pe.values())t.Dt();this.Fe.Dt(),this.Se.Dt()}}const b={readShort:(l,t)=>(b.t.uint16[0]=l[t]<<8|l[t+1],b.t.int16[0]),readUshort:(l,t)=>l[t]<<8|l[t+1],readUshorts(l,t,i){const r=[];for(let n=0;n<i;n++)r.push(b.readUshort(l,t+2*n));return r},readUint(l,t){const i=b.t.uint8;return i[3]=l[t],i[2]=l[t+1],i[1]=l[t+2],i[0]=l[t+3],b.t.uint32[0]},readASCII(l,t,i){let r="";for(let n=0;n<i;n++)r+=String.fromCharCode(l[t+n]);return r},writeUshort(l,t,i){l[t]=i>>>8&255,l[t+1]=255&i},writeUint(l,t,i){l[t]=i>>>24&255,l[t+1]=i>>>16&255,l[t+2]=i>>>8&255,l[t+3]=255&i},writeASCII(l,t,i){for(let r=0;r<i.length;r++)l[t+r]=255&i.charCodeAt(r)},t:(()=>{const l=new ArrayBuffer(8);return{uint8:new Uint8Array(l),int16:new Int16Array(l),uint16:new Uint16Array(l),uint32:new Uint32Array(l)}})()};function Z(l){return l+3&-4}function $(l,t,i){const r=t+i;let n=0;const o=b.t;for(let h=t;h<r;h+=4)o.uint8[3]=l[h]||0,o.uint8[2]=l[h+1]||0,o.uint8[1]=l[h+2]||0,o.uint8[0]=l[h+3]||0,n=n+(o.uint32[0]>>>0)>>>0;return n>>>0}class Dt{constructor(t){c(this,"b");c(this,"p",0);c(this,"bitbuf",0);c(this,"bitcnt",0);this.b=t}readBits(t){for(;this.bitcnt<t;){const r=this.b[this.p++]||0;this.bitbuf|=r<<this.bitcnt,this.bitcnt+=8}const i=this.bitbuf&(1<<t)-1;return this.bitbuf>>>=t,this.bitcnt-=t,i}alignToByte(){this.bitbuf=0,this.bitcnt=0}get offset(){return this.p}}function Y(l){let t=32,i=0;for(const a of l)a&&(a<t&&(t=a),a>i&&(i=a));if(i===0)return{min:0,max:0,table:new Map};const r=new Uint32Array(i+1);for(const a of l)a&&r[a]++;const n=new Uint32Array(i+1);let o=0;r[0]=0;for(let a=1;a<=i;a++)o=o+r[a-1]<<1,n[a]=o;const h=new Map;for(let a=0;a<l.length;a++){const u=l[a];if(!u)continue;const f=n[u]++;let g=h.get(u);g||(g=[],h.set(u,g)),g[_t(f,u)]=a}return{min:t,max:i,table:h}}function tt(l,t){let i=0;for(let r=1;r<=t.max;r++){i|=l.readBits(1)<<r-1;const n=t.table.get(r);if(n&&i<n.length){const o=n[i];if(o!==void 0)return o}}throw Error("Invalid Huffman code")}function _t(l,t){let i=0;for(let r=0;r<t;r++)i=i<<1|1&l,l>>>=1;return i>>>0}function St(l){if(l.length<2)throw Error("ZLIB data too short");const t=l[0],i=l[1];if((15&t)!=8)throw Error("Unsupported ZLIB compression method");if(((t<<8)+i)%31!=0)throw Error("Bad ZLIB header check");let r=2;32&i&&(r+=4);const n=[];return function(o,h){const a=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258],u=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],f=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],g=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13];let d=0;for(;!d;){d=o.readBits(1);const p=o.readBits(2);if(p===0){o.alignToByte();const y=o.readBits(16);if((65535&(65535^y))!==o.readBits(16))throw Error("DEFLATE uncompressed LEN/NLEN mismatch");for(let A=0;A<y;A++)h.push(o.readBits(8))}else{if(p!==1&&p!==2)throw Error("Unsupported DEFLATE type");{let y,A;if(p===1){const m=Array(288).fill(0);for(let x=0;x<=143;x++)m[x]=8;for(let x=144;x<=255;x++)m[x]=9;for(let x=256;x<=279;x++)m[x]=7;for(let x=280;x<=287;x++)m[x]=8;y=Y(m),A=Y(Array(32).fill(5))}else{const m=o.readBits(5)+257,x=o.readBits(5)+1,v=o.readBits(4)+4,T=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],w=Array(19).fill(0);for(let M=0;M<v;M++)w[T[M]]=o.readBits(3);const O=Y(w),U=[];for(;U.length<m+x;){const M=tt(o,O);if(M<=15)U.push(M);else if(M===16){const W=o.readBits(2)+3,N=U[U.length-1]||0;for(let gt=0;gt<W;gt++)U.push(N)}else if(M===17){const W=o.readBits(3)+3;for(let N=0;N<W;N++)U.push(0)}else{if(M!==18)throw Error("Invalid code length symbol");{const W=o.readBits(7)+11;for(let N=0;N<W;N++)U.push(0)}}}const P=U.slice(0,m),L=U.slice(m,m+x);y=Y(P),A=Y(L)}for(;;){const m=tt(o,y);if(m<256)h.push(m);else{if(m===256)break;if(m>256&&m<286){const x=m-257;let v=a[x];const T=u[x];T&&(v+=o.readBits(T));const w=tt(o,A);if(w>=30)throw Error("Invalid distance symbol");let O=f[w];const U=g[w];U&&(O+=o.readBits(U));const P=h.length-O;if(P<0)throw Error("Invalid distance");for(let L=0;L<v;L++)h.push(h[P+L]||0)}else if(m===286||m===287)throw Error("Reserved length symbol")}}}}}}(new Dt(l.subarray(r)),n),new Uint8Array(n)}function Bt(l){const t=b,i=new Uint8Array(l);if(t.readASCII(i,0,4)!=="wOFF")throw Error("Invalid WOFF signature");const r=t.readUint(i,4),n=t.readUshort(i,12),o=t.readUint(i,16),h=[];let a=44;for(let v=0;v<n;v++){const T=t.readASCII(i,a,4),w=t.readUint(i,a+4),O=t.readUint(i,a+8),U=t.readUint(i,a+12),P=t.readUint(i,a+16);h.push({tag:T,offset:w,compLength:O,origLength:U,checksum:P}),a+=20}for(const v of h){const T=new Uint8Array(i.buffer,v.offset,v.compLength);if(v.compLength===v.origLength)v.data=new Uint8Array(T);else if(v.data=St(T),v.data.length!==v.origLength)if(v.data.length<v.origLength){const w=new Uint8Array(v.origLength);w.set(v.data),v.data=w}else v.data=v.data.subarray(0,v.origLength)}const u=n;let f=1,g=0;for(;f<<1<=u;)f<<=1,g++;const d=16*f,p=16*u-d;let y=12+16*u;const A={};for(const v of h)A[v.tag]=y,y=Z(y+v.data.length);const m=new Uint8Array(Math.max(o||0,y));t.writeUint(m,0,r),t.writeUshort(m,4,u),t.writeUshort(m,6,d),t.writeUshort(m,8,g),t.writeUshort(m,10,p);let x=12;for(const v of h){t.writeASCII(m,x,v.tag),x+=4;let T=v.data;if(v.tag==="head"&&T.length>=12){const w=new Uint8Array(T);t.writeUint(w,8,0);const O=$(w,0,Z(w.length));t.writeUint(m,x,O),x+=4}else{const w=$(T,0,Z(T.length));t.writeUint(m,x,w),x+=4}t.writeUint(m,x,A[v.tag]),x+=4,t.writeUint(m,x,v.data.length),x+=4}for(const v of h){const T=A[v.tag];m.set(v.data,T)}if(h.find(v=>v.tag==="head")){const v=A.head,T=function(w,O){const U=b,P=O+8,L=[w[P],w[P+1],w[P+2],w[P+3]];U.writeUint(w,P,0);const M=2981146554-($(w,0,Z(w.length))>>>0)>>>0;return w[P]=L[0],w[P+1]=L[1],w[P+2]=L[2],w[P+3]=L[3],M>>>0}(m,v);t.writeUint(m,v+8,T)}return m.buffer}const It={parseTab(l,t,i){const r={tables:[],ids:{},off:t};l=new Uint8Array(l.buffer,t,i),t=0;const n=b,o=n.readUshort,h=o(l,t+=2);t+=2;const a=[];for(let u=0;u<h;u++){const f=o(l,t),g=o(l,t+=2);t+=2;const d=n.readUint(l,t);t+=4;const p=`p${f}e${g}`;let y=a.indexOf(d);if(y===-1){let A;y=r.tables.length,a.push(d);const m=o(l,d);A=m===4?this.parse4(l,d):m===12?this.parse12(l,d):{format:m},r.tables.push(A)}r.ids[p]=y}return r},parse4(l,t){const i=b,r=i.readUshort,n=i.readUshorts,o=t,h=r(l,t+=2);t+=2;const a=r(l,t+=2)>>>1,u={format:4,searchRange:r(l,t+=2),entrySelector:0,rangeShift:0,endCount:[],startCount:[],idDelta:[],idRangeOffset:[],glyphIdArray:[]};t+=2,u.entrySelector=r(l,t),t+=2,u.rangeShift=r(l,t),t+=2,u.endCount=n(l,t,a),t+=2*a,t+=2,u.startCount=n(l,t,a),t+=2*a;for(let f=0;f<a;f++)u.idDelta.push(i.readShort(l,t)),t+=2;return u.idRangeOffset=n(l,t,a),t+=2*a,u.glyphIdArray=n(l,t,o+h-t>>1),u},parse12(l,t){const i=b.readUint;i(l,t+=4),i(l,t+=4);const r=i(l,t+=4);t+=4;const n=new Uint32Array(3*r);for(let o=0;o<3*r;o+=3)n[o]=i(l,t+(o<<2)),n[o+1]=i(l,t+(o<<2)+4),n[o+2]=i(l,t+(o<<2)+8);return{format:12,groups:n}}},Nt={parseTab(l,t,i){const r=b;t+=18;const n=r.readUshort(l,t);t+=2,t+=16;const o=r.readShort(l,t);t+=2;const h=r.readShort(l,t);t+=2;const a=r.readShort(l,t);t+=2;const u=r.readShort(l,t);return t+=2,t+=6,{unitsPerEm:n,xMin:o,yMin:h,xMax:a,yMax:u,indexToLocFormat:r.readShort(l,t)}}},zt={parseTab(l,t,i){const r=b;t+=4;const n=["ascender","descender","lineGap","advanceWidthMax","minLeftSideBearing","minRightSideBearing","xMaxExtent","caretSlopeRise","caretSlopeRun","caretOffset","res0","res1","res2","res3","metricDataFormat","numberOfHMetrics"],o={};for(let h=0;h<n.length;h++){const a=n[h],u=a==="advanceWidthMax"||a==="numberOfHMetrics"?r.readUshort:r.readShort;o[a]=u(l,t+2*h)}return o}},Gt={parseTab(l,t,i,r){const n=b,o=[],h=[],a=r.maxp.numGlyphs,u=r.hhea.numberOfHMetrics;let f=0,g=0,d=0;for(;d<u;)f=n.readUshort(l,t+(d<<2)),g=n.readShort(l,t+(d<<2)+2),o.push(f),h.push(g),d++;for(;d<a;)o.push(f),h.push(g),d++;return{aWidth:o,lsBearing:h}}},ot={cmap:It,head:Nt,hhea:zt,maxp:{parseTab(l,t,i){const r=b;return r.readUint(l,t),t+=4,{numGlyphs:r.readUshort(l,t)}}},hmtx:Gt,loca:{parseTab(l,t,i,r){const n=b,o=[],h=r.head.indexToLocFormat,a=r.maxp.numGlyphs+1;if(h===0)for(let u=0;u<a;u++)o.push(n.readUshort(l,t+(u<<1))<<1);else if(h===1)for(let u=0;u<a;u++)o.push(n.readUint(l,t+(u<<2)));return o}},glyf:{parseTab(l,t,i,r){const n=[],o=r.maxp.numGlyphs;for(let h=0;h<o;h++)n.push(null);return n},Qe(l,t){const i=b,r=l.Je,n=l.loca;if(n[t]===n[t+1])return null;const o=D.findTable(r,"glyf",l.ti);if(!o)return null;let h=o[0]+n[t];const a={};if(a.noc=i.readShort(r,h),h+=2,a.xMin=i.readShort(r,h),h+=2,a.yMin=i.readShort(r,h),h+=2,a.xMax=i.readShort(r,h),h+=2,a.yMax=i.readShort(r,h),h+=2,a.xMin>=a.xMax||a.yMin>=a.yMax)return null;if(a.noc>0){a.endPts=[];for(let p=0;p<a.noc;p++)a.endPts.push(i.readUshort(r,h)),h+=2;const u=i.readUshort(r,h);if(h+=2,r.length-h<u)return null;h+=u;const f=a.endPts[a.noc-1]+1;a.flags=[];for(let p=0;p<f;p++){const y=r[h];if(h++,a.flags.push(y),8&y){const A=r[h];h++;for(let m=0;m<A;m++)a.flags.push(y),p++}}a.xs=[];for(let p=0;p<f;p++){const y=a.flags[p],A=!!(16&y);2&y?(a.xs.push(A?r[h]:-r[h]),h++):A?a.xs.push(0):(a.xs.push(i.readShort(r,h)),h+=2)}a.ys=[];for(let p=0;p<f;p++){const y=a.flags[p],A=!!(32&y);4&y?(a.ys.push(A?r[h]:-r[h]),h++):A?a.ys.push(0):(a.ys.push(i.readShort(r,h)),h+=2)}let g=0,d=0;for(let p=0;p<f;p++)g+=a.xs[p],d+=a.ys[p],a.xs[p]=g,a.ys[p]=d}else a.parts=[],a.endPts=[],a.flags=[],a.xs=[],a.ys=[];return a}}},D={parse(l){const t=new Uint8Array(l),i=b.readASCII(t,0,4);if(i==="wOFF")l=Bt(l);else if(i==="wOF2")throw Error("WOFF2 is not supported in this build (Brotli + WOFF2 transforms required)");return[((r,n,o,h)=>{const a=ot,u={Je:r,si:n,ti:o};for(const f in a){const g=f,d=D.findTable(r,g,o);if(d){const[p,y]=d;let A=h[p];A==null&&(A=a[g].parseTab(r,p,y,u),h[p]=A),u[g]=A}}return u})(new Uint8Array(l),0,0,{})]},findTable(l,t,i){const r=b,n=r.readUshort(l,i+4);let o=i+12;for(let h=0;h<n;h++){const a=r.readASCII(l,o,4);r.readUint(l,o+4);const u=r.readUint(l,o+8),f=r.readUint(l,o+12);if(a===t)return[u,f];o+=16}return null},T:ot,B:b};class Ht{ei(t){var r;const i=[];return(r=t.cmap)!=null&&r.tables?(t.cmap.tables.forEach(n=>{if(n.format===4){const o=this.ii(n);i.push(...o)}else if(n.format===12){const o=this.ri(n);i.push(...o)}}),[...new Set(i)]):[]}ni(t){return t.filter(i=>this.oi(i))}ii(t){const i=[];if(!(t.startCount&&t.endCount&&t.idRangeOffset&&t.idDelta))return i;for(let r=0;r<t.startCount.length;r++){const n=t.startCount[r],o=t.endCount[r];if(n!==65535||o!==65535){for(let h=n;h<=o;h++)if(this.hi(t,h,r)>0)try{const a=String.fromCodePoint(h);i.push(a)}catch{}}}return i}ri(t){const i=[];if(!t.groups)return i;for(let r=0;r<t.groups.length;r+=3){const n=t.groups[r],o=t.groups[r+1],h=t.groups[r+2];for(let a=n;a<=o;a++)if(h+(a-n)>0)try{const u=String.fromCodePoint(a);i.push(u)}catch{}}return i}hi(t,i,r){if(t.idRangeOffset[r]===0)return i+t.idDelta[r]&65535;{const n=t.idRangeOffset[r]/2+(i-t.startCount[r])-(t.startCount.length-r);if(n>=0&&t.glyphIdArray&&n<t.glyphIdArray.length){const o=t.glyphIdArray[n];if(o!==0)return o+t.idDelta[r]&65535}}return 0}oi(t){const i=t.codePointAt(0)||0;return!(i>=0&&i<=31&&i!==9&&i!==10&&i!==13||i>=127&&i<=159)}}class et{constructor(){c(this,"ai",new Map);c(this,"ci",new Map)}li(t,i){const r=`${this.ui(t)}_${i}`;if(this.ai.has(r))return this.ai.get(r);const n=t.cmap;if(!n||!n.tables)return this.ai.set(r,0),0;let o=0;for(const h of n.tables)if(h.format===4?o=this.fi(i,h):h.format===12&&(o=this.di(i,h)),o>0)break;return this.ai.set(r,o),o}pi(t,i){const r=i.codePointAt(0);return r===void 0?0:this.li(t,r)}_i(t,i){const r=t.hmtx;return r&&r.aWidth&&r.aWidth.length!==0?i<r.aWidth.length?r.aWidth[i]:r.aWidth[r.aWidth.length-1]:0}mi(t,i){const r=i/t.head.unitsPerEm,n=t.hhea.ascender*r,o=t.hhea.descender*r,h=t.hhea.lineGap*r;return{ascender:n,descender:o,lineGap:h,lineHeight:n-o+h,unitsPerEm:t.head.unitsPerEm,scale:r}}gi(){this.ai.clear(),this.ci.clear()}ui(t){return`${t.ti}_${t.Je.length}`}fi(t,i){const r=i.endCount.length;let n=-1;for(let o=0;o<r;o++)if(t<=i.endCount[o]){n=o;break}if(n===-1||t<i.startCount[n])return 0;if(i.idRangeOffset[n]===0)return t+i.idDelta[n]&65535;{const o=i.idRangeOffset[n]/2+(t-i.startCount[n])-(r-n);if(o>=0&&o<i.glyphIdArray.length){const h=i.glyphIdArray[o];return h===0?0:h+i.idDelta[n]&65535}}return 0}di(t,i){const r=i.groups.length/3;for(let n=0;n<r;n++){const o=i.groups[3*n],h=i.groups[3*n+1],a=i.groups[3*n+2];if(t>=o&&t<=h)return a+(t-o)}return 0}}class Xt{constructor(t){c(this,"Ai");c(this,"yi");c(this,"xt");c(this,"wi");this.xt=t,this.wi=new et,this.Ai=document.createElement("canvas"),this.yi=this.Ai.getContext("2d",{willReadFrequently:!0,alpha:!0})}createTextureAtlas(t,i,r,n){const o=t.length,h=Math.ceil(Math.sqrt(o)),a=Math.ceil(o/h),u=i.width*h,f=i.height*a,g=typeof n=="object"?n:null;this.Ci(u,f),this.bi(t,i,h,r,g);const d=this.xt.Ye(u,f,1,{filter:"nearest"});return d.Tt(this.Ai),{framebuffer:d,columns:h,rows:a}}Ci(t,i){this.Ai.width=t,this.Ai.height=i,this.Ai.style.width=t+"px",this.Ai.style.height=i+"px",this.yi.imageSmoothingEnabled=!1,this.Ai.style.imageRendering="pixelated",this.yi.clearRect(0,0,t,i),this.yi.textBaseline="top",this.yi.textAlign="left",this.yi.fillStyle="white"}bi(t,i,r,n,o){const h=n/o.head.unitsPerEm;for(let a=0;a<t.length;a++){const u=a%r,f=Math.floor(a/r),g=t[a].character,d=this.xi(o,g);if(!d)continue;const p=g.codePointAt(0)||0,y=this.wi.li(o,p),A=this.Mi(o,y)*h,m=u*i.width,x=f*i.height,v=m+.5*i.width,T=x+.5*i.height,w=Math.round(v-.5*i.width),O=Math.round(T-.5*n),U=w+.5*(i.width-A),P=O+o.hhea.ascender*h;this.Fi(d,U,P,h)}}xi(t,i){const r=i.codePointAt(0)||0,n=this.wi.li(t,r);if(n===0)return null;if(t.glyf&&t.glyf[n]!==null)return t.glyf[n];if(D&&D.T&&D.T.glyf){const o=D.T.glyf.Qe(t,n);return t.glyf&&o&&(t.glyf[n]=o),o}return null}Mi(t,i){const r=t.hmtx;return r&&r.aWidth?i<r.aWidth.length?r.aWidth[i]:r.aWidth[r.aWidth.length-1]:0}Fi(t,i,r,n){if(!t||!t.xs||t.noc===0)return;const{xs:o,ys:h,endPts:a,flags:u}=t;if(!(o&&h&&a&&u))return;this.yi.beginPath();let f=0;for(let g=0;g<a.length;g++){const d=a[g];if(!(d<f)){if(d>=f){const p=i+o[f]*n,y=r-h[f]*n;this.yi.moveTo(p,y);let A=f+1;for(;A<=d;)if(1&u[A]){const m=i+o[A]*n,x=r-h[A]*n;this.yi.lineTo(m,x),A++}else{const m=i+o[A]*n,x=r-h[A]*n;let v=A+1>d?f:A+1;if(1&u[v]){const T=i+o[v]*n,w=r-h[v]*n;this.yi.quadraticCurveTo(m,x,T,w),A=v+1}else{const T=(m+(i+o[v]*n))/2,w=(x+(r-h[v]*n))/2;this.yi.quadraticCurveTo(m,x,T,w),A=v}}this.yi.closePath()}f=d+1}}this.yi.fill()}}class Yt{constructor(){c(this,"zi");this.zi=new et}Ri(t,i,r){let n=0;const o=this.zi.mi(r,i),h=o.lineHeight;for(const a of t){const u=this.zi.pi(r,a);if(u===0)continue;const f=this.zi._i(r,u)*o.scale;n=Math.max(n,f)}return{width:Math.ceil(n),height:Math.ceil(h)}}gi(){this.zi.gi()}}class Wt{constructor(){c(this,"wi");this.wi=new et}createCharacterObjects(t,i){return t.map((r,n)=>{const o=r.codePointAt(0)||0,h=this.Ti(n);let a=0;if(i.hmtx&&i.hmtx.aWidth){const u=this.wi.li(i,o);u>0&&i.hmtx.aWidth[u]!==void 0&&(a=i.hmtx.aWidth[u])}return{character:r,unicode:o,color:h,advanceWidth:a}})}Ti(t){return[t%256/255,Math.floor(t/256)%256/255,Math.floor(t/65536)%256/255]}Pi(t,i){if(!X.v(typeof t=="string","Character must be a string.",{method:"getCharacterColor",providedValue:t}))return[0,0,0];const r=i.find(n=>n.character===t);return r?r.color:[0,0,0]}Si(t,i){return X.v(typeof t=="string"&&t.length>0,"Characters must be a string with at least one character.",{method:"getCharacterColors",providedValue:t})?Array.from(t).map(r=>this.Pi(r,i)||[0,0,0]):[[0,0,0]]}}class ht{constructor(t,i=16){c(this,"$i");c(this,"Ei",[]);c(this,"Di");c(this,"ki",16);c(this,"Bi",0);c(this,"Li",0);c(this,"Oi",{width:0,height:0});c(this,"Hi");c(this,"Gi",new Map);c(this,"Ii");c(this,"Ni");c(this,"Xi");c(this,"Wi");this.ki=i,this.Ii=new Ht,this.Ni=new Xt(t),this.Xi=new Yt,this.Wi=new Wt}async Ki(t){let i;if(t){const r=await fetch(t);if(!r.ok)throw new R(`Failed to load font file: ${r.status} ${r.statusText}`);i=await r.arrayBuffer()}else i=await(await fetch("data:font/woff;base64,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")).arrayBuffer();await this.ji(i),this.$i=D.parse(i)[0],await this.Yi()}Vi(t){if(t===void 0)return this.ki;this.ki=t,this.Oi=this.Xi.Ri(this.Ei.map(r=>r.character),this.ki,this.$i);const i=this.Ni.createTextureAtlas(this.Ei,this.Oi,this.ki,this.$i);this.Di=i.framebuffer,this.Bi=i.columns,this.Li=i.rows}async qi(t){try{const i=await fetch(t);if(!i.ok)throw new R(`Failed to load font file: ${i.status} ${i.statusText}`);const r=await i.arrayBuffer();await this.ji(r);const n=D.parse(r);if(!n||n.length===0)throw Error("Failed to parse font file");this.$i=n[0],await this.Yi()}catch(i){throw new R("Failed to load font: "+(i instanceof Error?i.message:"Unknown error"),i)}}async ji(t){const i=Date.now();this.Hi=new FontFace("CustomFont_"+i,t),await this.Hi.load(),document.fonts.add(this.Hi)}async Yi(){const t=this.Ii.ei(this.$i),i=this.Ii.ni(t);this.Gi.clear(),this.Ei=this.Wi.createCharacterObjects(i,this.$i),this.Oi=this.Xi.Ri(i,this.ki,this.$i);const r=this.Ni.createTextureAtlas(this.Ei,this.Oi,this.ki,this.$i);this.Di=r.framebuffer,this.Bi=r.columns,this.Li=r.rows}Pi(t){return this.Wi.Pi(t,this.Ei)}Si(t){return this.Wi.Si(t,this.Ei)}getGlyphData(t){if(!Number.isFinite(t))return null;const i=this.Gi.get(t);if(i!==void 0)return i;const r=this.Zi(t);if(r<0)return this.Gi.set(t,null),null;const n=this.$i.glyf;if(!n)return this.Gi.set(t,null),null;let o=n[r]??null;return o==null&&(o=D.T.glyf.Qe(this.$i,r)??null,n[r]=o),this.Gi.set(t,o),o}Zi(t){const i=this.$i.cmap;for(const r of i.tables)if(r.format===4){const n=r;for(let o=0;o<n.startCount.length;o++)if(t>=n.startCount[o]&&t<=n.endCount[o]){if(n.idRangeOffset[o]===0)return t+n.idDelta[o]&65535;{const h=n.idRangeOffset[o]/2+(t-n.startCount[o])-(n.startCount.length-o);if(h>=0&&h<n.glyphIdArray.length){const a=n.glyphIdArray[h];if(a!==0)return a+n.idDelta[o]&65535}}}}else if(r.format===12){const n=r;for(let o=0;o<n.groups.length;o+=3){const h=n.groups[o],a=n.groups[o+1],u=n.groups[o+2];if(t>=h&&t<=a)return u+(t-h)}}return 0}Dt(){this.Di.Dt(),document.fonts.delete(this.Hi)}get fontFramebuffer(){return this.Di}get characters(){return this.Ei}get textureColumns(){return this.Bi}get textureRows(){return this.Li}get maxGlyphDimensions(){return this.Oi}get fontSize(){return this.ki}get font(){return this.$i}}class at{constructor(t,i,r){c(this,"Qi");c(this,"Ji");c(this,"dt");c(this,"_t");c(this,"tr");c(this,"sr");c(this,"er");c(this,"ir");c(this,"rr");this.er=t,this.ir=i,this.rr=r,this.nr()}nr(){this.Qi=Math.floor(this.er.width/this.ir),this.Ji=Math.floor(this.er.height/this.rr),this.dt=this.Qi*this.ir,this._t=this.Ji*this.rr,this.tr=Math.floor((this.er.width-this.dt)/2),this.sr=Math.floor((this.er.height-this._t)/2)}hr(t,i){this.ir=t,this.rr=i,this.nr()}get cellWidth(){return this.ir}get cellHeight(){return this.rr}get cols(){return this.Qi}get rows(){return this.Ji}get width(){return this.dt}get height(){return this._t}get offsetX(){return this.tr}get offsetY(){return this.sr}}class ct{constructor(t={}){c(this,"er");c(this,"ar",null);c(this,"cr",!1);c(this,"lr");c(this,"ur");this.cr=t.overlay??!1,this.cr&&t.canvas?(this.ar=t.canvas,this.er=this.dr(),this.ur=!0,this.pr()):t.canvas?(this.er=t.canvas,this.ur=!1):(this.er=this._r(t.width,t.height),this.ur=!0),this.er.style.imageRendering="pixelated"}_r(t,i){const r=document.createElement("canvas");return r.className="textmodeCanvas",r.style.imageRendering="pixelated",r.width=t||800,r.height=i||600,document.body.appendChild(r),r}dr(){const t=document.createElement("canvas");t.className="textmodeCanvas",t.style.imageRendering="pixelated";const i=this.ar.getBoundingClientRect();let r=Math.round(i.width),n=Math.round(i.height);if(this.ar instanceof HTMLVideoElement){const a=this.ar;(r===0||n===0)&&a.videoWidth>0&&a.videoHeight>0&&(r=a.videoWidth,n=a.videoHeight)}t.width=r,t.height=n,t.style.position="absolute",t.style.pointerEvents="none";const o=window.getComputedStyle(this.ar);let h=parseInt(o.zIndex||"0",10);return isNaN(h)&&(h=0),t.style.zIndex=""+(h+1),t}pr(){var t;this.mr(),(t=this.ar.parentNode)==null||t.insertBefore(this.er,this.ar.nextSibling),window.ResizeObserver&&(this.lr=new ResizeObserver(()=>{this.vr()}),this.lr.observe(this.ar)),window.addEventListener("resize",()=>{this.vr()})}mr(){if(!this.ar)return;const t=this.ar.getBoundingClientRect();let i=this.ar.offsetParent;if(i&&i!==document.body){const r=i.getBoundingClientRect();this.er.style.top=t.top-r.top+"px",this.er.style.left=t.left-r.left+"px"}else this.er.style.top=t.top+window.scrollY+"px",this.er.style.left=t.left+window.scrollX+"px"}vr(t,i){if(this.cr){const r=this.ar.getBoundingClientRect();let n=Math.round(r.width),o=Math.round(r.height);if(this.ar instanceof HTMLVideoElement){const h=this.ar;(n===0||o===0)&&h.videoWidth>0&&h.videoHeight>0&&(n=h.videoWidth,o=h.videoHeight)}this.er.width=n,this.er.height=o,this.mr()}else this.er.width=t??this.er.width,this.er.height=i??this.er.height}gr(){const t=this.er.getContext("webgl2",{alpha:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!0,antialias:!1,depth:!1,stencil:!1,powerPreference:"high-performance"});if(!t)throw new R("`textmode.js` requires WebGL2 support.");return t}Dt(){this.lr&&this.lr.disconnect();const t=this.er.getContext("webgl")||this.er.getContext("webgl2");if(t){const i=t.getExtension("WEBGL_lose_context");i&&i.loseContext()}this.ur&&this.er.parentNode&&this.er.parentNode.removeChild(this.er)}get canvas(){return this.er}get targetCanvas(){return this.ar}get width(){return this.er.width}get height(){return this.er.height}}class H{constructor(t,i,r,n){c(this,"Ar");c(this,"dt");c(this,"_t");c(this,"gt");c(this,"k",0);c(this,"K",0);c(this,"j",0);c(this,"L",[0,0]);c(this,"yr","sampled");c(this,"wr","fixed");c(this,"V",[1,1,1,1]);c(this,"q",[0,0,0,1]);c(this,"Cr",[0,0,0,1]);c(this,"br",[[.1,0,0]]);c(this,"Mr");this.gt=t,this.Ar=i,this.dt=r,this._t=n}Dt(){this.gt.deleteTexture(this.Ar)}Fr(t){return typeof t=="boolean"?t?1:0:(t==null?0:Number(t))>0?1:0}invert(t=!0){return this.k=this.Fr(t),this}flipX(t=!0){return this.K=this.Fr(t),this}flipY(t=!0){return this.j=this.Fr(t),this}charRotation(t){const i=255*t/360,r=Math.floor(i)/255,n=Math.round(i-Math.floor(i));return this.L=[r,n],this}Ge(){return{texture:this.Ar,invert:this.k,flipX:this.K,flipY:this.j,charRotation:this.L,charColorFixed:this.yr==="fixed",charColor:this.V,cellColorFixed:this.wr==="fixed",cellColor:this.q,backgroundColor:this.Cr,charCount:this.br.length,charList:this.br}}charColorMode(t){return this.yr=t,this}cellColorMode(t){return this.wr=t,this}charColor(t,i,r,n){return this.V=[(t??0)/255,(i??t??0)/255,(r??t??0)/255,(n??255)/255],this}cellColor(t,i,r,n){return this.q=[(t??0)/255,(i??t??0)/255,(r??t??0)/255,(n??255)/255],this}background(t,i,r,n){return this.Cr=[(t??0)/255,(i??t??0)/255,(r??t??0)/255,(n??255)/255],this}characters(t){const i=this.Mr(t).filter(r=>Array.isArray(r)).slice(0,64);return this.br=i,this}static zr(t,i,r){const n=t.context,o=n.createTexture();n.bindTexture(n.TEXTURE_2D,o),n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,1),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,i),n.bindTexture(n.TEXTURE_2D,null);const h=i.naturalWidth??i.width??i.videoWidth??0,a=i.naturalHeight??i.height??i.videoHeight??0,u=new H(n,o,h,a);return u.Mr=r,u}get texture(){return this.Ar}get width(){return this.dt}get height(){return this._t}}class kt{constructor(t=60){c(this,"Rr");c(this,"Tr");c(this,"Pr",null);c(this,"Sr",0);c(this,"$r",!0);c(this,"Er",0);c(this,"Dr",0);c(this,"kr",[]);c(this,"Br",10);c(this,"Lr",0);this.Rr=t,this.Tr=1e3/t}start(t){if(!this.$r)return;this.Sr=performance.now();const i=r=>{if(!this.$r)return void(this.Pr=null);const n=r-this.Sr;n>=this.Tr&&(t(),this.Sr=r-n%this.Tr),this.$r&&(this.Pr=requestAnimationFrame(i))};this.Pr=requestAnimationFrame(i)}stop(){this.Pr&&(cancelAnimationFrame(this.Pr),this.Pr=null)}pause(){this.$r&&(this.$r=!1,this.stop())}resume(t){this.$r||(this.$r=!0,this.start(t))}frameRate(t,i){if(t===void 0)return this.Er;this.Rr=t,this.Tr=1e3/t,this.$r&&i&&(this.stop(),this.start(i))}measureFrameRate(){const t=performance.now();if(this.Dr>0){const i=t-this.Dr;this.kr.push(i),this.kr.length>this.Br&&this.kr.shift();const r=this.kr.reduce((n,o)=>n+o,0)/this.kr.length;this.Er=1e3/r}this.Dr=t}get isLooping(){return this.$r}get frameRateLimit(){return this.Rr}get currentFrameRate(){return this.Er}get frameCount(){return this.Lr}set frameCount(t){this.Lr=t}incrementFrame(){this.Lr++}resetFrameCount(){this.Lr=0}}class lt{constructor(t){c(this,"er");c(this,"Or");c(this,"Hr",{x:-1,y:-1});c(this,"Gr",{x:-1,y:-1});c(this,"Ir",null);c(this,"Nr",0);c(this,"Xr");c(this,"Wr");c(this,"Kr");c(this,"jr");c(this,"Yr");c(this,"Vr");c(this,"qr",!1);c(this,"Zr");c(this,"Qr");c(this,"Jr");c(this,"tn");c(this,"sn");this.er=t}en(t){const i=performance.now()+Math.max(0,t);i>this.Nr&&(this.Nr=i)}rn(){return performance.now()<this.Nr}nn(t){const i=this.er.canvas;i.style.cursor=t==null||t===""?"":t}Ki(t){this.Or=t,this.hn()}an(){if(this.qr)return;const t=this.er.canvas;this.Xr=i=>{this.cn(i),this.ln(i)},this.Wr=()=>{this.Gr={...this.Hr},this.Hr.x=-1,this.Hr.y=-1,this.Ir=null},this.Kr=i=>{this.cn(i),this.un(i)},this.jr=i=>{this.cn(i),this.fn(i)},this.Yr=i=>{this.cn(i),this.dn(i)},this.Vr=i=>{this.cn(i),this.pn(i)},t.addEventListener("mousemove",this.Xr,{passive:!0}),t.addEventListener("mouseleave",this.Wr,{passive:!0}),t.addEventListener("mousedown",this.Kr,{passive:!0}),t.addEventListener("mouseup",this.jr,{passive:!0}),t.addEventListener("click",this.Yr,{passive:!0}),t.addEventListener("wheel",this.Vr,{passive:!1}),this.qr=!0}_n(){if(!this.qr)return;const t=this.er.canvas;t.removeEventListener("mousemove",this.Xr),t.removeEventListener("mouseleave",this.Wr),t.removeEventListener("mousedown",this.Kr),t.removeEventListener("mouseup",this.jr),t.removeEventListener("click",this.Yr),t.removeEventListener("wheel",this.Vr),this.qr=!1}hn(){if(this.qr)try{if(this.Ir){const t=new MouseEvent("mousemove",{clientX:this.Ir.x,clientY:this.Ir.y,bubbles:!1,cancelable:!1});this.cn(t)}else this.Hr.x!==-1&&this.Hr.y!==-1&&(this.Hr.x>=this.Or.cols||this.Hr.y>=this.Or.rows)&&(this.Hr.x=-1,this.Hr.y=-1)}catch{this.Hr.x=-1,this.Hr.y=-1}}mn(t){this.Zr=t}vn(t){this.Qr=t}gn(t){this.Jr=t}An(t){this.tn=t}yn(t){this.sn=t}wn(){return{x:this.Hr.x,y:this.Hr.y}}ln(t){if(this.tn&&!this.rn()){const i={position:{...this.Hr},previousPosition:{...this.Gr},originalEvent:t};this.tn(i)}}un(t){if(this.Qr&&!this.rn()){const i={position:{...this.Hr},previousPosition:{...this.Gr},button:t.button,originalEvent:t};this.Qr(i)}}fn(t){if(this.Jr&&!this.rn()){const i={position:{...this.Hr},previousPosition:{...this.Gr},button:t.button,originalEvent:t};this.Jr(i)}}dn(t){if(this.Zr&&!this.rn()){const i={position:{...this.Hr},previousPosition:{...this.Gr},button:t.button,originalEvent:t};this.Zr(i)}}pn(t){if(this.sn&&!this.rn()){const i={position:{...this.Hr},previousPosition:{...this.Gr},delta:{x:t.deltaX,y:t.deltaY},originalEvent:t};this.sn(i)}}cn(t){const i=this.er.canvas;this.Gr={...this.Hr},this.Ir={x:t.clientX,y:t.clientY};const r=i.getBoundingClientRect(),n=t.clientX-r.left,o=t.clientY-r.top,h=i.width/r.width,a=o*(i.height/r.height),u=n*h-this.Or.offsetX,f=a-this.Or.offsetY,g=Math.floor(u/this.Or.cellWidth),d=Math.floor(f/this.Or.cellHeight);g>=0&&g<this.Or.cols&&d>=0&&d<this.Or.rows?(this.Hr.x=g,this.Hr.y=d):(this.Hr.x=-1,this.Hr.y=-1)}}const Vt=Object.freeze(Object.defineProperty({__proto__:null,MouseManager:lt},Symbol.toStringTag,{value:"Module"}));class ut{constructor(){c(this,"Cn",new Map);c(this,"bn",null);c(this,"xn",null);c(this,"Mn");c(this,"Fn");c(this,"qr",!1);c(this,"zn");c(this,"Rn");c(this,"Tn",{ArrowUp:"UP_ARROW",ArrowDown:"DOWN_ARROW",ArrowLeft:"LEFT_ARROW",ArrowRight:"RIGHT_ARROW",F1:"F1",F2:"F2",F3:"F3",F4:"F4",F5:"F5",F6:"F6",F7:"F7",F8:"F8",F9:"F9",F10:"F10",F11:"F11",F12:"F12",Enter:"ENTER",Return:"RETURN",Tab:"TAB",Escape:"ESCAPE",Backspace:"BACKSPACE",Delete:"DELETE",Insert:"INSERT",Home:"HOME",End:"END",PageUp:"PAGE_UP",PageDown:"PAGE_DOWN",Shift:"SHIFT",Control:"CONTROL",Alt:"ALT",Meta:"META"," ":"SPACE"})}an(){this.qr||(this.Mn=t=>{this.Pn(t)},this.Fn=t=>{this.Sn(t)},window.addEventListener("keydown",this.Mn,{passive:!1}),window.addEventListener("keyup",this.Fn,{passive:!1}),this.qr=!0)}_n(){this.qr&&(window.removeEventListener("keydown",this.Mn),window.removeEventListener("keyup",this.Fn),this.qr=!1,this.Cn.clear(),this.bn=null,this.xn=null)}vn(t){this.zn=t}gn(t){this.Rn=t}$n(t){const i=this.En(t),r=this.Cn.get(t)||this.Cn.get(i);return(r==null?void 0:r.isPressed)||!1}Dn(){return this.bn}kn(){return this.xn}Bn(){const t=[];for(const[i,r]of this.Cn)r.isPressed&&t.push(i);return t}Ln(){return{ctrl:this.$n("Control"),shift:this.$n("Shift"),alt:this.$n("Alt"),meta:this.$n("Meta")}}On(){this.Cn.clear(),this.bn=null,this.xn=null}Pn(t){const i=t.key,r=Date.now();this.Cn.has(i)||this.Cn.set(i,{isPressed:!1,lastPressTime:0,lastReleaseTime:0});const n=this.Cn.get(i);if(!n.isPressed&&(n.isPressed=!0,n.lastPressTime=r,this.bn=i,this.zn)){const o={key:i,keyCode:t.keyCode,ctrlKey:t.ctrlKey,shiftKey:t.shiftKey,altKey:t.altKey,metaKey:t.metaKey,isPressed:!0,originalEvent:t};this.zn(o)}}Sn(t){const i=t.key,r=Date.now();this.Cn.has(i)||this.Cn.set(i,{isPressed:!1,lastPressTime:0,lastReleaseTime:0});const n=this.Cn.get(i);if(n.isPressed=!1,n.lastReleaseTime=r,this.xn=i,this.Rn){const o={key:i,keyCode:t.keyCode,ctrlKey:t.ctrlKey,shiftKey:t.shiftKey,altKey:t.altKey,metaKey:t.metaKey,isPressed:!1,originalEvent:t};this.Rn(o)}}En(t){return this.Tn[t]||t.toLowerCase()}}const qt=Object.freeze(Object.defineProperty({__proto__:null,KeyboardManager:ut},Symbol.toStringTag,{value:"Module"}));class ft{constructor(t,i){c(this,"er");c(this,"Hn");c(this,"Or");c(this,"Gn",new Map);c(this,"In",new Map);c(this,"Nn",new Map);c(this,"Xn",null);c(this,"Wn");c(this,"Kn");c(this,"jn");c(this,"Yn");c(this,"Vn");c(this,"qn");c(this,"qr",!1);c(this,"Zn");c(this,"Qn");c(this,"Jn");c(this,"so");c(this,"eo");c(this,"io");c(this,"ro");c(this,"no");c(this,"oo");c(this,"ho");c(this,"ao",320);c(this,"co",350);c(this,"lo",10);c(this,"uo",550);c(this,"fo",14);c(this,"do",48);c(this,"po",650);c(this,"_o",.02);c(this,"mo",2);c(this,"vo",600);c(this,"Ao",0);c(this,"yo",null);this.er=t,this.Hn=i;const r=this.er.canvas;this.Wn=r.style.touchAction,this.Kn=r.style.userSelect,r.style.touchAction||(r.style.touchAction="none"),r.style.userSelect||(r.style.userSelect="none")}Ki(t){this.Or=t,this.wo()}an(){if(this.qr)return;const t=this.er.canvas;this.jn=i=>{this.Co(i)},this.Yn=i=>{this.bo(i)},this.Vn=i=>{this.xo(i)},this.qn=i=>{this.Mo(i)},t.addEventListener("touchstart",this.jn,{passive:!1}),t.addEventListener("touchmove",this.Yn,{passive:!1}),t.addEventListener("touchend",this.Vn,{passive:!1}),t.addEventListener("touchcancel",this.qn,{passive:!1}),this.qr=!0}_n(){if(!this.qr)return;const t=this.er.canvas;t.removeEventListener("touchstart",this.jn),t.removeEventListener("touchmove",this.Yn),t.removeEventListener("touchend",this.Vn),t.removeEventListener("touchcancel",this.qn),this.qr=!1,this.Xn=null,this.Gn.clear(),this.In.clear(),this.Nn.forEach(i=>{i.longPressTimer!==null&&window.clearTimeout(i.longPressTimer)}),this.Nn.clear(),this.yo=null,this.Ao=0,t.style.touchAction=this.Wn,t.style.userSelect=this.Kn}wo(){if(!this.Or||this.Gn.size===0)return;const t=new Map;for(const i of this.Gn.values()){const r=this.Fo(i.clientX,i.clientY,i.id,i);t.set(i.id,r)}this.Gn=t}zo(){return Array.from(this.Gn.values()).map(t=>({...t}))}Ro(t){this.Zn=t}An(t){this.Qn=t}To(t){this.Jn=t}Po(t){this.so=t}So(t){this.eo=t}$o(t){this.io=t}Eo(t){this.ro=t}Do(t){this.no=t}ko(t){this.oo=t}Bo(t){this.ho=t}Co(t){var n;if(!this.Or)return;t.preventDefault(),(n=this.Hn)==null||n.en(this.vo);const i=performance.now(),r=this.Lo(t.changedTouches);for(const o of r){const h=this.Gn.get(o.id);h&&this.In.set(o.id,this.Oo(h)),this.Gn.set(o.id,o);const a={id:o.id,startPosition:o,lastPosition:o,startTime:i,lastTime:i,longPressTimer:null,longPressFired:!1};this.ro&&(a.longPressTimer=window.setTimeout(()=>{const u=this.Gn.get(o.id);u&&(a.longPressFired=!0,this.ro({touch:this.Oo(u),duration:performance.now()-a.startTime,originalEvent:t}))},this.uo)),this.Nn.set(o.id,a),this.Zn&&this.Zn(this.Ho(o,t,void 0,i))}this.Gn.size===2&&this.Go()}bo(t){var n;if(!this.Or)return;t.preventDefault(),(n=this.Hn)==null||n.en(this.vo);const i=performance.now(),r=this.Lo(t.changedTouches);for(const o of r){const h=this.Gn.get(o.id),a=h?this.Oo(h):void 0;a&&this.In.set(o.id,a),this.Gn.set(o.id,o);const u=this.Nn.get(o.id);u&&(u.lastPosition=o,u.lastTime=i,a)&&this.Io(a,o,!0)>this.fo&&u.longPressTimer!==null&&(window.clearTimeout(u.longPressTimer),u.longPressTimer=null),this.Qn&&this.Qn(this.Ho(o,t,a,i))}this.Gn.size===2?this.No(t):this.Xn=null}xo(t){if(!this.Or)return;t.preventDefault();const i=performance.now(),r=this.Lo(t.changedTouches);for(const n of r){const o=this.Gn.get(n.id),h=o?this.Oo(o):void 0,a=this.Nn.get(n.id);a&&a.longPressTimer!==null&&(window.clearTimeout(a.longPressTimer),a.longPressTimer=null),this.Jn&&this.Jn(this.Ho(n,t,h,i)),a&&this.Xo(a,t),this.Nn.delete(n.id),this.In.delete(n.id),this.Gn.delete(n.id)}this.Gn.size<2&&(this.Xn=null)}Mo(t){if(!this.Or)return;t.preventDefault();const i=performance.now(),r=this.Lo(t.changedTouches);for(const n of r){const o=this.Gn.get(n.id),h=o?this.Oo(o):void 0,a=this.Nn.get(n.id);a&&a.longPressTimer!==null&&(window.clearTimeout(a.longPressTimer),a.longPressTimer=null),this.so&&this.so(this.Ho(n,t,h,i)),this.Nn.delete(n.id),this.In.delete(n.id),this.Gn.delete(n.id)}this.Gn.size<2&&(this.Xn=null)}Lo(t){const i=[];for(let r=0;r<t.length;r+=1){const n=t.item(r);n&&i.push(this.Wo(n))}return i}Wo(t){return this.Fo(t.clientX,t.clientY,t.identifier,{id:t.identifier,x:-1,y:-1,clientX:t.clientX,clientY:t.clientY,pressure:t.force,radiusX:t.radiusX,radiusY:t.radiusY,rotationAngle:t.rotationAngle})}Fo(t,i,r,n){const o=this.er.canvas,h=o.getBoundingClientRect(),a=t-h.left,u=i-h.top,f=o.width/h.width,g=u*(o.height/h.height),d=a*f-this.Or.offsetX,p=g-this.Or.offsetY,y=Math.floor(d/this.Or.cellWidth),A=Math.floor(p/this.Or.cellHeight),m=y>=0&&y<this.Or.cols&&A>=0&&A<this.Or.rows;return{id:r,x:m?y:-1,y:m?A:-1,clientX:t,clientY:i,pressure:n.pressure,radiusX:n.radiusX,radiusY:n.radiusY,rotationAngle:n.rotationAngle}}Ho(t,i,r,n){const o=this.Nn.get(t.id),h=Array.from(this.In.values()).map(f=>this.Oo(f)),a=Array.from(this.Gn.values()).map(f=>this.Oo(f)),u=this.Lo(i.changedTouches);return{touch:this.Oo(t),previousTouch:r?this.Oo(r):void 0,touches:a,previousTouches:h,changedTouches:u,deltaTime:o?n-o.lastTime:0,originalEvent:i}}Go(){if(this.Gn.size!==2)return void(this.Xn=null);const t=Array.from(this.Gn.values()),[i,r]=t,n=this.Io(i,r,!1),o=this.Ko(i,r);this.Xn={ids:[i.id,r.id],initialDistance:Math.max(n,1e-4),initialAngle:o,lastScale:1,lastRotation:0}}No(t){if(this.Xn||this.Go(),!this.Xn)return;const[i,r]=this.Xn.ids,n=this.Gn.get(i),o=this.Gn.get(r);if(!n||!o)return;const h=this.Io(n,o,!1)/this.Xn.initialDistance,a=h-this.Xn.lastScale;this.oo&&Math.abs(a)>this._o&&(this.oo({touches:[this.Oo(n),this.Oo(o)],scale:h,deltaScale:a,center:this.jo(n,o),originalEvent:t}),this.Xn.lastScale=h);let u=this.Ko(n,o)-this.Xn.initialAngle;u=(u+180)%360-180;const f=u-this.Xn.lastRotation;this.ho&&Math.abs(f)>this.mo&&(this.ho({touches:[this.Oo(n),this.Oo(o)],rotation:u,deltaRotation:f,center:this.jo(n,o),originalEvent:t}),this.Xn.lastRotation=u)}jo(t,i){const r=(t.clientX+i.clientX)/2,n=(t.clientY+i.clientY)/2,o=this.Fo(r,n,-1,{id:-1,x:-1,y:-1,clientX:r,clientY:n});return{x:o.x,y:o.y}}Xo(t,i){const r=performance.now(),n=r-t.startTime,o=this.Io(t.startPosition,t.lastPosition,!0);if(!t.longPressFired&&n<=this.ao&&o<=this.lo)this.Yo(t.lastPosition,r)&&this.io?this.io({touch:this.Oo(t.lastPosition),taps:2,originalEvent:i}):this.eo&&this.eo({touch:this.Oo(t.lastPosition),taps:1,originalEvent:i});else if(!t.longPressFired&&n<=this.po&&o>=this.do){const h={x:t.lastPosition.clientX-t.startPosition.clientX,y:t.lastPosition.clientY-t.startPosition.clientY},a=Math.max(Math.hypot(h.x,h.y),1e-4),u={x:h.x/a,y:h.y/a},f={x:h.x/n,y:h.y/n};this.no&&this.no({touch:this.Oo(t.lastPosition),direction:u,distance:a,velocity:f,originalEvent:i})}this.Ao=r,this.yo=this.Oo(t.lastPosition)}Yo(t,i){return!!this.yo&&!(i-this.Ao>this.co)&&this.Io(t,this.yo,!0)<=this.lo}Oo(t){return{...t}}Io(t,i,r){return r?Math.hypot(t.clientX-i.clientX,t.clientY-i.clientY):Math.hypot(t.x-i.x,t.y-i.y)}Ko(t,i){return 180*Math.atan2(i.clientY-t.clientY,i.clientX-t.clientX)/Math.PI}}const Kt=Object.freeze(Object.defineProperty({__proto__:null,TouchManager:ft},Symbol.toStringTag,{value:"Module"})),jt=l=>class extends l{rotate(t=0,i=0,r=0){this.xt.state.st(t),this.xt.state.et(i),this.xt.state.it(r)}rotateX(t){this.xt.state.st(t)}rotateY(t){this.xt.state.et(t)}rotateZ(t){this.xt.state.it(t)}push(){this.xt.state.G()}pop(){this.xt.state.Z()}rect(t,i,r=1,n=1){this.xt.Ne(t,i,r,n)}point(t,i){this.xt.Ne(t,i,1,1)}line(t,i,r,n){this.xt.Xe(t,i,r,n)}lineWeight(t){this.xt.state.tt(t)}background(t,i=t,r=t,n=255){this.xt.qe(t,i,r,n)}char(t){this.xt.state.rt(this.$i.Pi(t))}charColor(t,i,r,n=255){this.xt.state.nt(t,i,r,n)}cellColor(t,i,r,n=255){this.xt.state.ot(t,i,r,n)}flipX(t){this.xt.state.ht(t)}flipY(t){this.xt.state.ct(t)}charRotation(t){this.xt.state.ut(t)}invert(t){this.xt.state.lt(t)}clear(){this.xt.qe(0,0,0,0)}ellipse(t,i,r,n){this.xt.We(t,i,r/2,n/2)}triangle(t,i,r,n,o,h){this.xt.Ke(t,i,r,n,o,h)}bezierCurve(t,i,r,n,o,h,a,u){this.xt.je(t,i,r,n,o,h,a,u)}arc(t,i,r,n,o,h){this.xt.Ve(t,i,r,n,o,h)}shader(t){this.xt.Be(t)}setUniform(t,i){this.xt.Kt(t,i)}setUniforms(t){this.xt.Le(t)}createFilterShader(t){return this.xt.hs(t)}createFramebuffer(t){return this.xt.Ye(t.width,t.height,5,{filter:"nearest",wrap:"clamp",format:"rgba",type:"unsigned_byte"})}image(t,i,r,n,o){if(t.textures){const h=t;this.xt.Oe(h,i,r,n??h.width,o??h.height)}else{const h=t;this.xt.He(h,i,r,n??Math.floor(this.Or.cols/2),o??Math.floor(this.Or.rows/2))}}async loadImage(t){if(typeof t!="string")return H.zr(this.xt,t,n=>this.$i.Si(n));const i=t,r=await new Promise((n,o)=>{const h=new Image;h.crossOrigin="anonymous",h.onload=()=>n(h),h.onerror=a=>o(a),h.src=i});return H.zr(this.xt,r,n=>this.$i.Si(n))}},Zt=l=>class extends l{async loadFont(t){return this.$i.qi(t).then(()=>{const i=this.$i.maxGlyphDimensions;this.Or.hr(i.width,i.height),this.Vo.resize(this.Or.cols,this.Or.rows),this.xt.Ze(),this.Hn.hn()})}fontSize(t){if(!X.v(typeof t=="number"&&t>0,"Font size must be a positive number greater than 0.",{method:"fontSize",providedValue:t})||this.$i.fontSize===t)return;this.$i.Vi(t);const i=this.$i.maxGlyphDimensions;this.Or.hr(i.width,i.height),this.Vo.resize(this.Or.cols,this.Or.rows),this.xt.Ze(),this.Hn.hn()}glyphColor(t){return this.$i.Pi(t)}glyphColors(t){return this.$i.Si(t)}},Qt=l=>class extends l{get frameCount(){return this.qo.frameCount}set frameCount(t){this.qo.frameCount=t}frameRate(t){return t===void 0?this.qo.currentFrameRate:this.qo.frameRate(t,()=>this.Zo())}noLoop(){this.qo.pause()}loop(){this.qo.resume(()=>this.Zo())}redraw(t=1){if(X.v(typeof t=="number"&&t>0&&Number.isInteger(t),"Redraw count must be a positive integer.",{method:"redraw",providedValue:t}))for(let i=0;i<t;i++)this.Zo()}isLooping(){return this.qo.isLooping}},Jt=l=>class extends l{constructor(...t){super(...t)}mouseClicked(t){this.Hn.mn(t)}mousePressed(t){this.Hn.vn(t)}mouseReleased(t){this.Hn.gn(t)}mouseMoved(t){this.Hn.An(t)}mouseScrolled(t){this.Hn.yn(t)}get mouse(){return this.Hn.wn()}cursor(t){this.Hn.nn(t)}},$t=l=>class extends l{constructor(...t){super(...t)}touchStarted(t){this.Qo.Ro(t)}touchMoved(t){this.Qo.An(t)}touchEnded(t){this.Qo.To(t)}touchCancelled(t){this.Qo.Po(t)}tap(t){this.Qo.So(t)}doubleTap(t){this.Qo.$o(t)}longPress(t){this.Qo.Eo(t)}swipe(t){this.Qo.Do(t)}pinch(t){this.Qo.ko(t)}rotateGesture(t){this.Qo.Bo(t)}get touches(){return this.Qo.zo()}},te=l=>class extends l{constructor(...t){super(...t)}keyPressed(t){this.Jo.vn(t)}keyReleased(t){this.Jo.gn(t)}isKeyPressed(t){return this.Jo.$n(t)}get lastKeyPressed(){return this.Jo.Dn()}get lastKeyReleased(){return this.Jo.kn()}get pressedKeys(){return this.Jo.Bn()}get modifierState(){return this.Jo.Ln()}};class ee{constructor(t){c(this,"th");c(this,"sh",new Map);c(this,"eh",[]);c(this,"ih",new Map);c(this,"rh",new Map);this.th=t}async nh(t){for(const i of t){if(this.sh.has(i.name))return void console.warn(`[textmode.js] Plugin "${i.name}" is already installed.`);const r=this.oh(i.name);try{await i.install(this.th,r)}catch(n){throw this.hh(i.name),n}this.sh.set(i.name,i),this.eh.push(i.name)}}async ah(t){const i=this.sh.get(t);if(!i)return;const r=this.oh(t);if(i.uninstall)try{await i.uninstall(this.th,r)}catch(n){console.error(`[textmode.js] Error while uninstalling plugin "${t}":`,n)}this.sh.delete(t),this.eh.splice(this.eh.indexOf(t),1),this.hh(t)}runPreDrawHooks(){this.uh(this.ih,"preDraw")}runPostDrawHooks(){this.uh(this.rh,"postDraw")}async fh(){const t=[...this.sh.keys()];for(const i of t)await this.ah(i)}oh(t){return{...this.th.dh(),registerPreDrawHook:i=>this.ph(this.ih,t,i),registerPostDrawHook:i=>this.ph(this.rh,t,i)}}ph(t,i,r){const n=t.get(i)??new Set;return n.add(r),t.set(i,n),()=>{const o=t.get(i);o&&(o.delete(r),o.size===0&&t.delete(i))}}hh(t){this.ih.delete(t),this.rh.delete(t)}uh(t,i){for(const r of this.eh){const n=t.get(r);if(n)for(const o of n)try{o()}catch(h){console.error(`[textmode.js] Plugin "${r}" ${i} hook failed:`,h)}}}}class ie{constructor(){c(this,"xt");c(this,"$i");c(this,"er");c(this,"Or");c(this,"qo");c(this,"Hn");c(this,"Qo");c(this,"Jo");c(this,"_h");c(this,"Vo");c(this,"mh");c(this,"gh");c(this,"Ah")}Zo(){}}class dt extends function(i,...r){return r.reduce((n,o)=>o(n),i)}(ie,jt,Zt,Qt,Jt,$t,te){constructor(i={}){super();c(this,"yh");c(this,"wh",!1);c(this,"Ch",()=>{});c(this,"bh",()=>{});c(this,"xh",()=>{});c(this,"Mh");c(this,"lr");c(this,"cr",!1);c(this,"Fh");this.yh=new ee(this),this.cr=i.overlay??!1,this.er=new ct(i),this.xt=new Lt(this.er.gr()),this.$i=new ht(this.xt,i.fontSize??16),this.qo=new kt(i.frameRate??60),this.Hn=new lt(this.er),this.Qo=new ft(this.er,this.Hn),this.Jo=new ut,this._h=this.xt.Pt(),this.mh=this.xt.rs(),this.zh(i)}async zh(i){await this.$i.Ki(i.fontSource);const r=this.$i.maxGlyphDimensions;this.Or=new at(this.er.canvas,r.width,r.height),this.Hn.Ki(this.Or),this.Qo.Ki(this.Or),this.Vo=this.xt.Ye(this.Or.cols,this.Or.rows,5),this.gh=this.xt.Ye(this.Or.width,this.Or.height,1),this.cr&&(this.Fh=H.zr(this.xt,this.er.targetCanvas,n=>this.$i.Si(n))),this.Ah=this.xt.cs(rt,"precision mediump float;uniform sampler2D Ua;uniform vec2 Ub;uniform vec2 Uc;uniform vec2 Ud;void main(){vec2 A=gl_FragCoord.xy-Uc;vec2 B=A*(Ub/Ud);vec2 C=(floor(B)+0.5)/Ub;gl_FragColor=texture2D(Ua,C);}"),this.Rh(),await this.yh.nh(i.plugins??[]),this.Ch(),this.qo.start(()=>this.Zo())}dh(){return{renderer:this.xt,font:this.$i,grid:this.Or,canvas:this.er,drawFramebuffer:this.Vo,asciiFramebuffer:this.gh,flushDrawCommands:()=>{this.xt.St(this._h)}}}Rh(){this.Mh=()=>{this.cr&&this.resizeCanvas(this.er.targetCanvas.width,this.er.targetCanvas.height),this.xh()},window.addEventListener("resize",this.Mh),this.Hn.an(),this.Qo.an(),this.Jo.an(),window.addEventListener("blur",()=>{this.Jo.On()}),window.ResizeObserver&&this.cr&&(this.lr=new ResizeObserver(()=>{this.resizeCanvas(this.er.targetCanvas.width,this.er.targetCanvas.height)}),this.lr.observe(this.er.targetCanvas))}Zo(){if(this.qo.measureFrameRate(),this.qo.incrementFrame(),this.wh)return;if(this.cr){const r=this.xt.context;r.bindTexture(r.TEXTURE_2D,this.Fh.texture),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,1),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,this.er.targetCanvas),r.bindTexture(r.TEXTURE_2D,null)}this.yh.runPreDrawHooks(),this.Vo.begin(),this.xt.ke(this._h),this.bh(),this.xt.St(this._h),this.Vo.end(),this.gh.begin(),this.xt.ke(this.mh),this.mh.Wt({U0:this.$i.fontFramebuffer,U1:[this.$i.textureColumns,this.$i.textureRows],U2:this.Vo.textures[0],U3:this.Vo.textures[1],U4:this.Vo.textures[2],U5:this.Vo.textures[4],U6:this.Vo.textures[3],U7:[this.Or.cols,this.Or.rows],U8:[this.gh.width,this.gh.height],U9:this.gh.width/this.gh.height}),this.xt.Ie(0,0,this.er.width,this.er.height),this.gh.end();const i=this.xt.state.canvasBackgroundColor;this.xt.Ys(i[0],i[1],i[2],i[3]),this.xt.ke(this.Ah),this.Ah.Wt({Ua:this.gh.textures[0],Ub:[this.gh.width,this.gh.height],Uc:[this.Or.offsetX,this.Or.offsetY],Ud:[this.Or.width,this.Or.height]}),this.xt.Ie(this.Or.offsetX,this.Or.offsetY,this.Or.width,this.Or.height),this.yh.runPostDrawHooks()}setup(i){this.Ch=i}draw(i){this.bh=i}windowResized(i){this.xh=i}resizeCanvas(i,r){this.er.vr(i,r),this.Or.nr(),this.Vo.resize(this.Or.cols,this.Or.rows),this.gh.resize(this.Or.width,this.Or.height),this.xt.Ze(),this.Hn.hn(),this.Qo.wo(),this.Zo()}destroy(){this.wh||(this.qo.stop(),this.yh.fh().catch(i=>{console.error("[textmode.js] Error while disposing plugins:",i)}),window.removeEventListener("resize",this.Mh),this.Hn._n(),this.Qo._n(),this.Jo._n(),this.$i.Dt(),this.xt.Dt(),this.gh.Dt(),this.Ah.Dt(),this.Fh&&this.Fh.Dt(),this.wh=!0)}get grid(){return this.Or}get font(){return this.$i}get width(){return this.er.width}get height(){return this.er.height}get canvas(){return this.er.canvas}get drawFramebuffer(){return this.Vo}get isDisposed(){return this.wh}get overlay(){return this.Fh}}class Q{constructor(){}static create(t={}){return new dt(t)}static setErrorLevel(t){X.A(t)}static get version(){return"0.4.0"}}const se=Object.freeze(Object.defineProperty({__proto__:null,keyboard:qt,mouse:Vt,touch:Kt},Symbol.toStringTag,{value:"Module"})),re=Q.create,ne=Q.setErrorLevel,oe=Q.version;C.TextmodeCanvas=ct,C.TextmodeErrorLevel=S,C.TextmodeFont=ht,C.TextmodeFramebuffer=q,C.TextmodeGrid=at,C.TextmodeImage=H,C.Textmodifier=dt,C.create=re,C.input=se,C.setErrorLevel=ne,C.textmode=Q,C.version=oe,Object.defineProperty(C,Symbol.toStringTag,{value:"Module"})},typeof exports=="object"&&typeof module<"u"?e(exports):typeof define=="function"&&define.amd?define(["exports"],e):e((s=typeof globalThis<"u"?globalThis:s||self).textmode={});
